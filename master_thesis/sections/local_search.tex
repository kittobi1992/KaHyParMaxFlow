We will give now a detailed description of our flow-based refinement framework. The main
idea is to extract a subhypergraph $H_{V'}$ out of the original hypergraph $H$, which is already
partitioned into $k$ blocks. $V'$ is choosen in such a way that it is a subset of two
adjacent blocks $V_i$ and $V_j$. We will show how to configure
the sources $S$ and sinks $T$ of the corresponding flow network such that
a minimum $(S,T)$-bipartition of $H_{V'}$ improves the connectivity metric on $H$
(see Section \ref{sec:source_and_sink}). Further, we describe how the ideas of
Sanders and Schulz \cite{sanders2011engineering} (see Section \ref{sec:flow_local_search_graph}) 
could be adapted to work in a $n$-level hypergraph partitioner, called \emph{KaHyPar}
(see Section \ref{sec:mbmc_hypergraphs} and \ref{sec:flow_local_search_hypergraph}). 

\subsection{Modelling Sources and Sinks}
\label{sec:source_and_sink}

Let $H = (V,E,c,\omega)$ be a hypergraph and $B_1 := (V_1, V_2)$ be a bipartition.
$H_{V'}$ is the subhypergraph induced by $V' \subseteq V$. 
Further, let $E_{\emptyset} = \{ e \cap V'\ |\ e \in E: e \cap V' = \emptyset\} $
be the set of all hyperedges contained in $H$, but not in $H_{V'}$. $T_L(H_{V'})$ 
(see Section \ref{sec:related_lawler}) is the flow problem induced by $H_{V'}$ with a
source set $S$ and a sink set $T$. Let $(V_1',V_2')$ be the minimum $(S,T)$-bipartition
obtained by a maximum $(S,T)$-flow calculation on $T_L(H_{V'})$ with $f$ as maximum flow
function. We can extend the bipartition $(V_1',V_2')$ of $H_{V'}$ to a bipartition 
$B_2 := (V_1 \setminus V'\ \cup\ V_1',\ V_2 \setminus V'\ \cup V_2' )$ on $H$. Finally,
we define the cut on subhypergraph $H_{V'}$ related to a
bipartion $(V_1,V_2)$:
\[\omega_{H_{V'}}(V_1,V_2) := \sum_{e \in E(V_1,V_2) \setminus E_{\emptyset}} \omega(e) \]
Some will wonder about the defnition of the cut $\omega_{H_{V'}}$ over the
cut edges of $H$. A cut hyperedge $e$ of $H$ must not necessarily be a cut hyperedge
of $H_{V'}$. E.g., if $e = \{v_1,v_2\}$ with $v_1 \in V_1$ and $v_2 \in V_2$, but
$v_1 \in V'$ and $v_2 \notin V'$. Then $e$ is cut in $H$, but not in $H_{V'}$, because
$v_2$ is removed from $e$ per definition of $E_{V'}$. However, the reason that we still
define $e$ as cut hyperedge of $H_{V'}$ has to do with our problem statement, 
which we will define as follows:

\begin{problem}
\label{prob:ST}
How do we have to define the source set $S$ and sink set $T$ for a subhypergraph $H_{V'}$ 
(with $V' \subseteq V$) and a bipartition $B_1$, such that 
after a maximum $(S,T)$-flow calculation (with $f$ as maximum flow function)
the resulting bipartition $B_2$ on $H$ satisfy the following conditions:
\begin{enumerate}
\item $\omega_H(B_2) \le \omega_H(B_1)$
\item $\Delta_{H} := \omega_H(B_1) - \omega_H(B_2) = \omega_{H_{V'}}(B_1) - |f| =: \Delta_{H_{V'}}$
\end{enumerate}
\end{problem}

The first condition ensures that a maximum $(S,T)$-flow calculation on $T_L(H_{V'})$ never 
decrease the cut of $H$. The existence of the second condition has practical reasons. First, we
can simply update the cut metric via $\omega_H(B_2) = w_H(B_1) - \Delta_{H_{V'}}$,
instead of summing up the weight of all cut hyperedges. Since, we have to setup the subhypergraph
$H_{V'}$ before each maximum flow computation we can implicitly calculate $\omega_{H_{V'}}(B_1)$.
Therefore, the cut metric can be updated after the \emph{Max-Flow-Min-Cut} computation
in constant time instead of \BigO{|E|}. On the other hand, we can assert the correctness of
our own maximum flow algorithm. If $\Delta_H \neq \Delta_{H_{V'}}$, then with high probability our
flow algorithm is incorrect. Also, the reason why we define $\omega_{H_{V'}}(V_1,V_2)$ over
the cut hyperedges of $H$ is due to the fact that the equality
\[\Delta_{H} := \omega_H(B_1) - \omega_H(B_2) = \omega_{H_{V'}}(B_1) - \omega_{H_{V'}}(B_2)\]
holds. If we are able to show that $|f| = \omega_{H_{V'}}(B_2)$, we simultanously show
that $\Delta_H = \Delta_{H_{V'}}$.\\
We will now present a solution for our problem statement. First, we show how $S$ and $T$
can be choosen to satisfy condition (i). Afterwards, we extend $S$ and $T$ with additional
nodes to fullfil condition (ii). Finally, we show how $S$ and $T$ can be modified, such that
we can obtain smaller cuts on $H$ and simultanously satisfy condition (i) and (ii) of our problem
statement. \\
Let $V' \subseteq V$ and $\delta B = \{ e \in E\ |\ \exists u,v \in e: u \in V'\ \land\ v \notin V' \}$
be the set of all \emph{Border Hyperedges}. For a bipartition $(V_1,V_2)$ of $H$, we say
$v \in V_1$ is a source node of the flow network $T_L(H_{V'})$, if there exists
a hyperedge $e \in \delta B$ containing $v$ and at least one other node $u \in V_1$ with
$u \notin V'$. More formal:
\begin{align}
%S = \bigcup\limits_{\substack{e \in \delta B \\ |e \setminus V' \cap V_1| \neq 0}} (e \cap V_1 \cap V') \\
S_1 = \{ s \in V' \cap V_1\ |\ \exists v \notin V': \exists e \in \delta B: v \in V_1\ \land\ s,v \in e \} \label{S1_border_hyperedges}\\
T_1 = \{ t \in V' \cap V_2\ |\ \exists v \notin V': \exists e \in \delta B: v \in V_2\ \land\ v,t \in e \} \label{T1_border_hyperedges}
\end{align}
An example of a \emph{Max-Flow-Min-Cut} computation on $H_{V'}$ with $S$ and $T$ as source and
sink set is illustrated in \autoref{img:border_hyperedges}.
\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/border_hyperedges.eps}
\caption{Example how \emph{Border Hyperedges} are modelled as sources and sinks.}
\label{img:border_hyperedges}
\end{figure}

\begin{lemma}
\label{cut_decrease_proof}
Let $B_1$ be a bipartition of $H$ and $T_L(H_{V'})$ the flow network of subhypergraph
$H_{V'}$ with $S$ and $T$ as defined in Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges} (with $V' \subseteq V$).
Let $B_2$ be the bipartition obtained by a maximum $(S,T)$-flow computation on $T_L(H_{V'})$.
Then, $\omega_H(B_2) \le \omega_H(B_1)$.
\end{lemma}

\begin{proof}
A $(S,T)$ \emph{Max-Flow-Min-Cut} computation on $T_L(H_{V'})$ yields to a minimum $(S,T)$-cutset on 
$H_{V'}$ \cite{ford1956maximal}. Thus, for all hyperedges $e \notin \delta B \cup E_{\emptyset}$, which
are cut in $B_2$, the sum of their weight must be less or equal than the sum of all cut hyperedges
$e \notin \delta B \cup E_{\emptyset}$ of bipartition $B_1$. We need to show that a non-cut
hyperedge $e \in \delta B$ of $B_1 = (V_1,V_2)$ cannot become a cut hyperedge of
$B_2 = (V_1',V_2')$. Let $e \in \delta B$ be such a hyperedge. $e$ must be either a subset of $V_1$ or $V_2$, otherwise
$e$ is a cut hyperedge. Let $e \subseteq V_1$, then $e \cap V' \subseteq S$ (see Equation \ref{S1_border_hyperedges}). 
Defining a node $s \in S$ as source node means that it cannot change its block after a \emph{Max-Flow-Min-Cut}
computation. Therefore, $e \subseteq V_1$ and $e \subseteq V_1' \Rightarrow e$ is a non-cut
hyperedge in $B_2$. The proof for $e \subseteq V_2$ is equivalent $\Rightarrow \omega_H(B_2) 
\le \omega_H(B_1)$.
\end{proof} 

In the next step we will show how $S$ and $T$ can be extended to fullfil condition (ii)
of Problem \autoref{prob:ST}. Currently, $|f| \le \omega_{H_{V'}}(B_2)$ (without a prove).
Obviously, some nodes are missing in $S$ and $T$. Do understand which nodes are missing consider
\autoref{img:non_cut_flow_hyperedges}. Transformation $1$ illustrates our current modelling
approach defined in Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges}. The maximum
flow on this network is $|f| = 1$, but the resulting minimum $(S,T)$-bipartition $B_2$ induced 
a cut of $\omega_{H_{V'}}(B_2) = 2$. This due to the fact that $e_1$ and $e_3$ are cut
hyperedges in $H$, but non-cut hyperedges in $H_{V'}$. The actual cut of $H_{V'}$ is therefore
$1$ (instead of $2$) and this is also a minimum $(S,T)$-cut. Transformation $2$ illustrates the
correct modelling approach for cut hyperedges of $H$ which are non-cut hyperedges in $H_{V'}$.
For each hyperedge $e \in \delta B$ with $e \cap V' \subseteq V_2$ and $e \setminus V' \cap V_1 \neq \emptyset$, 
we add the \emph{incomming hyperedge node} $e'$ to $S$.
More formal:
\begin{align}
S = S_1 \cup \{e'\ |\ e \cap V' \subseteq V_2 \ \land\ e \setminus V' \cap V_1  \neq \emptyset\} \label{S_border_hyperedges}\\
T = T_1 \cup \{e''\ |\ e \cap V' \subseteq V_1 \ \land\ e \setminus V' \cap V_2 \neq \emptyset \} \label{T_border_hyperedges}
\end{align}

\begin{figure}
\centering
\includegraphics[width=1.0\textwidth]{../img/source_and_sink_set/non_cut_flow_hyperedges.eps}
\caption{In this example $e_1$ and $e_3$ are cut hyperedges of the hypergraph, but not of
        the subhypergraph induced by the flow problem. Modelling the \emph{outgoing} resp.
        \emph{incomming} hyperedge node of $e_1$ resp. $e_2$ as sink resp. source ensures
        that $\Delta_H = \Delta_{H_{V'}}$.} 
\label{img:non_cut_flow_hyperedges}
\end{figure}

\begin{lemma}
\label{lemma:delta_proof}
Let $B_1$ be a bipartition of $H$ and $T_L(H_{V'})$ the flow network of subhypergraph
$H_{V'}$ with $S$ and $T$ as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges} (with $V' \subseteq V$).
Let $B_2$ be the bipartition obtained by a maximum $(S,T)$-flow computation on $T_L(H_{V'})$
with $f$ as maximum flow function.
Then, $\omega_{H_{V'}}(B_2) = |f|$ ($\Rightarrow \Delta_H = \Delta_{H_{V'}}$).
\end{lemma}
 
\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/delta_proof_illustration.eps}
\caption{Illustration of the two cases presented in proof of Lemma \ref{lemma:delta_proof} in
         order to remove a hypernode $v \in V'' \cap S$ from $T_L(H_{V' \cup V''})$. }
\label{img:delta_proof_illustration}
\end{figure}

\begin{proof}
Let $V'' = \bigcup_{e \in \delta B} e \setminus V'$ be the set of all hypernodes contained
in a \emph{border hyperedge}, but not in $V'$. Let $H_{V' \cup V''}$ be the subhypergraph
obtained by extending $H_{V'}$ with all missing hypernodes of \emph{border hyperedges}. 
We define the flow problem $T_L(H_{V' \cup V''})$ with $S' = S_1\ \cup\ (V'' \cap V_1)$ and 
$T' = T_1\ \cup\ (V'' \cap V_2)$ as sources and sinks. Further, let $f'$ be a maximum $(S',T')$-flow 
on $T_L(H_{V' \cup V''})$ and $B_2$ be the corresponding minimum $(S',T')$-bipartition. Because
all hypernodes which are part of a hyperedge in $H$ and also in $H_{V'}$ are fully contained
in $H_{V' \cup V''}$ the equality $|f'| = \omega_{H_{V'}}(B_2)$ holds. In the following we 
present a technique with which we can obtain a new flow network $T_L(H_{V' \cup V''\setminus \{v\}})$
with $v \in V''$ and $S''$ and $T''$ as sources and sinks. Simultanously we map
the maximum $(S',T')$-flow $f'$ of $T_L(H_{V' \cup V''})$ to a maximum $(S'',T'')$-flow
of $T_L(H_{V' \cup V''\setminus \{v\}})$ with $|f'| = |f''|$. Applying this technique successively
on all nodes $v \in V''$ will result in the flow network $T_L(H_{V'})$ with $S$ and $T$ as sources and sinks
from Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges}. \\
A hypernode $v \in V''$ is either a source or a sink. We will show how to remove a source
hypernode $v \in V'' \cap S'$. At beginning we define $S'' := S'$, $T'' := T'$ and 
$f'' := f'$. In order to remove $v \in V''$ we have to distingush two cases 
based on a incident hyperedge $e \in I(v)$ of $v$: 

$\mathbf{e \cap S \setminus \{v\} \neq \emptyset}$:
Then there exists a hypernode $u \in e \cap S$ with $u \neq v$. We define
$f''(u,e') = f''(u,e') + f'(v,e')$ and $f''(s,u) = f''(s,u) + f'(v,e')$. 

$\mathbf{e \cap S \setminus \{v\} = \emptyset}$:
In this case $e$ must be a cut hyperedge in $H$, but not in $H_{V'}$, otherwise
there would exist a hypernode $u \in e \cap S$ (see Equation \ref{S1_border_hyperedges}).
We define $S'' = S'' \cup \{e'\}$. Simultanously, we set  
$f''(s,e') = f'(v,e')$. 

The two cases are illustrated in \autoref{img:delta_proof_illustration}.
We can remove $v$ from $T_L(H_{V' \cup V''})$ after applying this procedure for 
all $e \in I(v)$. The cases for a hypernode $v \in V'' \cap T'$ are equivalent. 
$f''$ is a valid flow function per construction and $|f'| = |f''|$. Also $f''$
is maximum $(S'',T'')$-flow on $T_L(H_{V' \cup V''\setminus \{v\}})$, otherwise
we can map a augmenting path in the residual graph $T_L(H_{V' \cup V''\setminus \{v\}})$
to a augmenting path in $T_L(H_{V' \cup V''})$ (without a proof). We can successively
remove all $v \in V''$ from $T_L(H_{V' \cup V''})$ with this method. \\
The resulting  flow network is $T_L(H_{V'})$. For each $e \in E$ which is cut in $H$, but not
in $H_{V'}$, we have added the corresponding \emph{incomming hyperedge node} $e'$
or \emph{outgoing hyperedge node} $e''$ to $S''$ resp. $T''$. Therefore, 
$S''$ and $T''$ are equal with $S$ and $T$ defined in Equation \ref{S_border_hyperedges}
and \ref{T_border_hyperedges}. Finally, the flow function $f''$ is a maximum
$(S,T)$-flow on $T_L(H_{V'})$ and $|f''| = |f'| = \omega_{H_{V'}}(B_2)$ per construction.
\end{proof}

With our current modelling approach we are able to satisfy all conditions of
our problem statement. However, sometimes we define hypernodes as source resp.
sink which are unnecessary. For a explanation consider \autoref{img:cut_border_hyperedges}.
Hyperedge $e_1$ is cut in $H_{V'}$ and contains hypernodes from both
blocks, which are not in the flow problem. Regardless what we do in $H_{V'}$
we can not remove $e_1$ from cut in $H$. Using our suggested source and sink modelling has
as consequence that $e_1$ and $e_2$ are still cut after a \emph{Max-Flow-Min-Cut} 
computation (see \emph{Transformation 1} in \autoref{img:cut_border_hyperedges}). Another approach
is to define for hyperedges which are cut of $H_{V'}$ and are also of $H$ the \emph{incomming}
resp. \emph{outgoing hyperedge node} as source resp. sink (see \emph{Transformation 2} in
\autoref{img:cut_border_hyperedges}). In our example all hypernodes of $e_1$ are still able 
to move and a \emph{Max-Flow-Min-Cut} computation removes $e_2$ from cut.\\
To define our final source and sink set, we split the set of all \emph{border hyperedges} into
three different disjoint subsets as follows:

\begin{enumerate}
\item $\delta B_1 = \{ e \in \delta B \ |\ e \subseteq V_1\ \lor\ e \subseteq V_2 \}$
\item $\delta B_2 = \{ e \in \delta B \ |\ e \cap V' \not\subseteq V_1\ \land\ e \cap V' \not\subseteq V_2\}$
\item $\delta B_3 = \{ e \in \delta B \setminus \delta B_1 \ |\ (e \cap V' \subseteq V_1\ \lor\ e \cap V' \subseteq V_2 \}$
\end{enumerate}

$\delta B_1$ contains all non-cut \emph{border hyperedges} of $H$. $\delta B_2$ contains 
all \emph{cut border hyperedges} of $H$, which are also cut in $H_{V'}$ and $\delta B_3$ contains
all \emph{cut border hyperedges} of $H$, which are non-cut in $H_{V'}$.
\begin{align}
S = \bigcup\limits_{\substack{e \in \delta B_1 \\ e \subseteq V_1}} e\cap V'\ \cup \bigcup\limits_{\substack{e \in \delta B_2 \cup \delta B_3 \\ e \setminus V' \cap V_1 \neq \emptyset}} \{e'\} \label{S_final_border_hyperedges}\\
T = \bigcup\limits_{\substack{e \in \delta B_1 \\ e \subseteq V_2}} e\cap V'\ \cup \bigcup\limits_{\substack{e \in \delta B_2 \cup \delta B_3 \\ e \setminus V' \cap V_2 \neq \emptyset}} \{e''\} \label{T_final_border_hyperedges}
\end{align}

\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/cut_border_hyperedges.eps}
\caption{Example how \emph{Cut Border Hyperedges} are modelled as sources and sinks. In this
         example $e_1$ contains node from block $V_1$ and $V_2$ not contained in the flow problem. Therefore,
         we can not remove $e_1$ from cut. Treating $e_1$ as a \emph{Border Hyperedge} would result
         in Transformation $1$. This has the consequence that we are not able to remove $e_2$
         from cut with a \emph{Max-Flow-Min-Cut} computation. Defining the \emph{incomming} resp.
         \emph{outgoing} hyperedge of $e_1$ as source resp. sinks allows the corresponding hypernodes
         of $e_1$ still to move. The consequence is that we can remove $e_2$ from cut with a
         \emph{Max-Flow-Min-Cut} computation in Transformation $2$.}
\label{img:cut_border_hyperedges}
\end{figure}

Equation \ref{S_final_border_hyperedges} and \ref{T_final_border_hyperedges} 
are illustrated in \autoref{img:st_modelling_summary}.
A \emph{Max-Flow-Min-Cut} computation on $T_L(H_{V'})$ with $S$ and $T$ as defined
in Equation \ref{S_final_border_hyperedges} and \ref{T_final_border_hyperedges} satisfy
condition (i) and (ii) of Problem \ref{prob:ST}. This can be prooven with similiar techniques
used in the proof of Lemma \ref{cut_decrease_proof} and \ref{lemma:delta_proof}. A maximum
$(S,T)$-flow calculation yields to a minimum $(S,T)$-cut on $H_{V'}$. A non-cut hyperedge
$e \in \delta B_1$ can not become a cut hyperedge after a \emph{Max-Flow-Min-Cut} computation,
because we still define all hypernodes $v \in e \cap V'$ as sources resp. sinks. Therefore,
$\omega_H(B_2) \le \omega_H(B_1)$. We can proof Lemma \ref{lemma:delta_proof} for our
new source and sink set if we adapt the conditions of the cases for a hyperedge $e \in I(v)$ 
based on the set $\delta B_1$, $\delta B_2$ and $\delta B_3$ where $e$ is contained. If
$e \in \delta B_1$, then there must exists a hypernode $u \in e \cap S \setminus \{v\}$ on
which we apply the first case (Case $1$: $e \cap S \setminus \{v\} \neq \emptyset$). 
For all $e \in \delta B_2 \cup \delta B_3$, we simply apply the second case
(Case $2$: $e \cap S \setminus \{v\} = \emptyset$). After removing all hypernodes $v \in V''$
the resulting network is $T_L(H_{V'})$ with $S$ and $T$ as defined in Equation
\ref{S_final_border_hyperedges} and \ref{T_final_border_hyperedges}. Further, the flow function
$f''$ is a maximum $(S,T)$-flow on $T_L(H_{V'})$ with $|f''| = |f'| = \omega_{H_{V'}}(B_2)
\Rightarrow \Delta_H = \Delta_{H_{V'}}$. \\
Finally, we want to show that for a minimum $(S',T')$-bipartition $B_2$ with $S'$ and $T'$ as defined
in Equation \ref{S_final_border_hyperedges} and \ref{T_final_border_hyperedges} and a minimum
$(S,T)$-bipartition $B_3$ with $S$ and $T$ as defined in Equation \ref{S_border_hyperedges}
and \ref{T_border_hyperedges} calculated with flow network $T_L(H_{V'})$ the inequality 
$\omega_H(B_2) \le \omega_H(B_3)$ holds. For this propose we need a preparing lemma.

\begin{lemma}
\label{lemma:ST_subset}
Let $G = (V,E,c)$ be a flow network with sources $S$ and sinks $T$. Further, let $S' \subseteq S$
and $T' \subseteq T$. The value of a maximum $(S',T')$-flow $f'$ is less or equal than the value
of a maximum $(S,T)$-flow $f$. More formal, $|f'| \le |f|$.
\end{lemma}

\begin{proof}
Assume $|f'| > |f|$. Then, we can simply set $f = f'$, because $S' \subseteq S$ and
$T' \subseteq T$. But this is a contradiction to assumption that $f$ is a maximum $(S,T)$-flow
on $G$. Therefore, $|f'| \le |f|$.
\end{proof}

In the following theorem, we denote with $S$ and $T$ the source and sink sets as defined in 
Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges} and with $S'$ and $T'$ the
source and sink sets as defined in Equation \ref{S_final_border_hyperedges} and
\ref{T_final_border_hyperedges}.

\begin{theorem}
Let $H$ be a hypergraph and $H_{V'}$ be the subhypergraph induced by the subset $V' \subseteq V$.
Further, $B_1$ is the current bipartition of $H$. For a minimum $(S',T')$-bipartition $B_2$ and
a minimum $(S,T)$-bipartition $B_3$ obtained by a maximum $(S',T')$- resp. $(S,T)$-flow calculation
on $T_L(H_{V'})$ the inequality $\omega_H(B_2) \le \omega_H(B_3) \le \omega_H(B_1)$ holds.
\end{theorem}

\begin{proof}
Let $(\bar{S'},\bar{T'})$ resp. $(\bar{S},\bar{T})$ be the sets obtained by removing all
\emph{incomming} and \emph{outgoing hyperedge nodes} $e'$ and $e''$ from $(S',T')$ resp.
$(S,T)$. It holds that $\bar{S'} \subseteq \bar{S}$ and $\bar{T'} \subseteq \bar{T}$. Afterwards,
we extend the subhypergraph $H_{V'}$ with all hypernodes $V'' = \bigcup_{e \in \delta B} e \setminus V'$
and obtain subhypergraph $H_{V' \cup V''}$ with flow network $T_L(H_{V' \cup V''})$.
Also we extend $(\bar{S'},\bar{T'})$ and $(\bar{S},\bar{T})$ exactly in the same way as 
in the proof of Theorem \ref{lemma:delta_proof}. With the \emph{Max-Flow-Min-Cut}-Theorem 
\cite{ford1956maximal} we can conclude that the cut value $\omega_{H_{V'}}(B_2)$ of 
a minimum $(\bar{S'},\bar{T'})$-bipartition $B_2$ on $H_{V'}$ is equal with the value of a 
maximum $(\bar{S'},\bar{T'})$-flow $f'$ on $T_L(H_{V' \cup V''})$. 
The same holds for a minimum $(\bar{S},\bar{T})$-bipartition
$B_3$ and a maximum $(\bar{S},\bar{T})$-flow $f$. After extending $(\bar{S'},\bar{T'})$ 
resp. $(\bar{S},\bar{T})$ with all hypernodes of $V''$ $\bar{S'} \subseteq \bar{S}$
and $\bar{T'} \subseteq \bar{T}$ still holds. With Lemma \ref{lemma:ST_subset} and the 
\emph{Max-Flow-Min-Cut}-Theorem follows $\omega_{H_{V'}}(B_2) = |f'| \le |f| = \omega_{H_{V'}}(B_3)$.\\
We can transform $(\bar{S'},\bar{T'})$ resp. $(\bar{S},\bar{T})$ and flow network $T_L(H_{V'\cup V''})$
back to $T_L(H_{V'})$ with $(S',T')$ resp. $(S,T)$ as source and sink sets
with the technique described in the proof of Theorem \ref{lemma:delta_proof} and in the sketch
of the proof for our new source and sink sets (see Equation \ref{S_final_border_hyperedges} and
\ref{T_final_border_hyperedges}). Therefore, the inequality still holds for bipartitions
$B_2$ and $B_3$ obtained by a maximum $(S',T')$- and $(S,T)$-flow calculation on $T_L(H_{V'})$.
Finally, it follows
\begin{align*}
\omega_H(B_2) \stackrel{\text{Problem \ref{prob:ST}(ii)}}{=} 
\omega_H(B_1) - \omega_{H_{V'}}(B_1) + |f'| \\
\stackrel{\text{Lemma \ref{lemma:ST_subset}}}{\le} \omega_H(B_1) - \omega_{H_{V'}}(B_1) + |f| \\
\stackrel{\text{Problem \ref{prob:ST}(ii)}}{=} \omega_H(B_3) \stackrel{\text{Problem \ref{prob:ST}(i)}}{\le} \omega_H(B_1)
\end{align*}
\end{proof}

We are now able to extract a subhypergraph $H_{V'}$ out of a already bipartitioned hypergraph $H$ and
calculate a minimum $(S,T)$-bipartition of $H_{V'}$ with $S$ and $T$ as defined
in Equation \ref{S_final_border_hyperedges} and \ref{T_final_border_hyperedges}. The resulting
bipartition induced a new cut on $H$ smaller or equal than the old cut. Further, we show with our
modelling technique of $S$ and $T$ that $\Delta_H$ can be calculated with the help of the value 
of a maximum $(S,T)$-flow computation on $T_L(H_{V'})$. Additionaly, we demonstrate that a different
modelling approach of $S$ and $T$ which satisfy both conditions of Problem \ref{prob:ST} can lead to
an improved cut quality of the minimum $(S,T)$-bipartition on the original hypergraph $H$.

\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/st_modelling_summary.eps}
\caption{Illustration of source and sink set modelling defined in Equation \ref{S_final_border_hyperedges}
         and \ref{T_final_border_hyperedges}. }
\label{img:st_modelling_summary}
\end{figure}

With the given approach we are able to optimize the cut metric of a given
bipartition of a hypergraph $H$. We can transfer those results in order to improve
a $k$-way partition $\Pi = (V_1,\ldots,V_k)$, if the objective is the connectivity
metric. Let $V' \subseteq V_i \cup V_j$ be a subset of the hypernodes of two adjacent
blocks $V_i$ and $V_j$ in the quotient graph. If we optimize the cut of
subhypergraph $H_{V'}$ we simultanously optimize the connectivity metric of $H$.
The reduction of the cut on $H_{V'}$ is then equal with the reduction of
the connectivity on $H$.

\subsection{Most Balanced Minimum Cuts on Hypergraphs}
\label{sec:mbmc_hypergraphs}

Picard and Queyranne \cite{picard1980structure} showed that all minimum $(s,t)$-cuts 
of a graph $G$ are computable with one maximum $(s,t)$-flow computation by 
iterating through all \emph{closed node sets} of the residual graph of $G$. 
The corresponding algorithm is presented in Section \ref{sec:related_mbmc}. \\
We can apply the same algorithm on hypergraphs. A minimum-capacity $(s,t)$-cutset of \ShortT{L}
is equal with a minimum-weight $(s,t)$-cutset of $H$. With the algorithm
of Section \ref{sec:related_mbmc} we are able to find all minimum-capacities
$(s,t)$-cutsets of \ShortT{L}, which are also minimum-weight $(s,t)$-cutsets
of $H$. The corresponding minimum-weight $(s,t)$-bipartitions are all
\emph{closed node sets} of the residual graph of \ShortT{L}. \\
However, when we use e.g. \ShortExT{H}{V'} (see Section \ref{sec:heuer_network})
or \ShortHybrid~(see Section \ref{sec:hybrid_network}) as underlying flow network
some hypernodes are removed from the flow problem. This a problem, if we want to
enumerate all minimum-weight $(s,t)$-bipartitions. The solution for 
this problem is quite simple. After a maximum $(s,t)$-flow calculation
on one of the two mentioned networks we insert all removed hypernodes with
their corresponding edges again into the residual graph of our flow network.
The maximum $(s,t)$-flow is still maximal, otherwise we would had found an \emph{augmenting
path} on the flow network before. We are now able to compute all minimum-weight
$(s,t)$-bipartitions the same way as with \ShortT{L}.

\subsection{A Direct $K$-Way Flow-Based Refinement Framework}
\label{sec:flow_local_search_hypergraph}

We described how a hypergraph $H$ could be transformed into
a flow network \ShortT{L} such that every minimum-capacity $(s,t)$-cutset on \ShortT{L} is a 
minimum-weight  $(s,t)$-cutset on $H$ (see Section \ref{sec:related_lawler}). 
Additionaly, we present techniques to sparsify the
flow network \ShortT{L} \cite{lawler1973} in order to reduce the complexity of 
the flow problem (see Section \ref{sec:opt_flow_network}). 
Further, we show how to configure the source and sink sets on the flow network of a 
subhypergraph $H_{V'}$ (with $V' \subseteq V$) such that a \emph{Max-Flow-Min-Cut} 
computation improves a given bipartition of $H$ (see Section \ref{sec:source_and_sink}). 
Finally, we are able to enumerate all minmum-weight $(s,t)$-cutsets of a subhypergraph 
$H_{V'}$ with one maximum $(s,t)$-flow calculation \cite{picard1980structure}. \\
We will now present our direct $k$-way flow-based refinement framework which we integrated
into the $n$-level hypergraph partitioner \emph{KaHyPar} \cite{heuer2017improving} 
(see Section \ref{sec:kahypar}). Our flow-based refinement approach optimizes
the \emph{connectivity} metric. We used a similiar architecture as proposed
by Sanders and Schulz \cite{sanders2011engineering} (see Section 
\ref{sec:flow_local_search_graph}). The basic concepts of the framework are
illustrated in \autoref{img:flow_framework}. \\
Our maximum flow calculations are embedded into an \emph{Active Block Scheduling}
refinement \cite{holtgrewe2010engineering} (see Section \ref{sec:abs}).
Each time we use flows to improve the connectivity metric of
a given $k$-way partition $\Pi$ we construct the quotient graph $Q$ of $\Pi$. 
Afterwards, we iterate over all edges of $Q$ in random order. For each edge
$(V_i,V_j)$ of $Q$ we grow a flow problem around the cut of the bipartition
induced by $V_i$ and $V_j$. In order to do that we use two \BFS, one only 
touches hypernodes of $V_i$ and the second only touches hypernodes of $V_j$.
The \BFS~are initialized with all hypernodes contained in a cut hyperedge
of the bipartition $(V_i,V_j)$. A pairwise flow-based refinement is embedded
into the \emph{adaptive flow iterations} strategy \cite{sanders2011engineering}
(see Section \ref{sec:adaptive_flow_iterations}) which also determines
the size of the flow problem. \\
After we define the subhypergraph $H_{V'}$, which we use to improve the bipartition
$(V_i,V_j)$ on $H$, we construct one of the flow networks proposed in Section
\ref{sec:opt_flow_network} with sources $S$ and sinks $T$ defined in
Section \ref{sec:source_and_sink}. We implemented two maximum flow algorithms.
One is a slightly modified \emph{augmenting path} algorithm of Emdond \& Karp
\cite{edmonds1972theoretical} (see Section \ref{sec:aug_path}) 
and the second is the \emph{Push-Relabel} algorithm of
Goldberg \& Tarjan \cite{cherkassky1997implementing,goldberg1988new} 
(see Section \ref{sec:push_relabel}). Since we have a 
\emph{Multi-Source-Multi-Sink} problem, we can find several \emph{augmenting paths}
with one \BFS. After we execute a \BFS~on the residual graph, we search 
as many as possible edge-disjoint paths in the resulting \BFS-tree connecting a source $s$
with a sink $t$. Our Goldberg \& Tarjan implementation uses a \emph{FIFO} queue and
the \emph{global relabeling} and \emph{gap} heurisitc \cite{cherkassky1997implementing}.
We do not use an external implementation of a maximum flow algorithm.
Since the \emph{I\textbackslash O} of writing a flow problem to memory and reading the
solution would significant slowdown the performance of our algorithm, because we have
to solve an enormous number of flow problems during the \emph{Active Block Scheduling}
refinement. After determine a maximum $(S,T)$-flow on our flow network we iterate over
all minimum $(S,T)$-bipartitions of $H_{V'}$ \cite{picard1980structure} and choose 
the \emph{Most Balanced Minimum Cut} (see Section \ref{sec:related_mbmc} and 
\ref{sec:mbmc_hypergraphs}) according to our \emph{balanced contraint}. \\
\emph{KaHyPar} is a $n$-level hypergraph partitioner ($|V| = n$) taking the 
multilevel paradigm to its extreme by removing only a single vertex in every level
of the hierarchy \cite{akhremtsev2017engineering} (see Section \ref{sec:kahypar}). 
During the refinement step $n$ local searches are instantiated. Therefore, 
using our flow-based refinement as local search algorithm on each level is not 
applicable, because the performance slowdown would be tremendous. On this
reason we introduce \emph{Flow Execution Policies}. One is to execute our flow-based
refinement on each level $i$ where $i = \beta\cdot j$ with $j \in \mathbb{N}_+$ and
$\beta$ as a predefined tunning parameter. Another approach is to simulate a
multilevel partitioner with $\log(n)$ hierarchies. A flow-based refinement is then
executed on each level $i$ where $i = 2^j$ with $j \in \mathbb{N}_+$. Each policy also
executes the \emph{Active Block Scheduling} refinement on the last level of the
hierarchy. In all remaining levels where no flow is executed, we can use a 
\emph{FM}-based local search algorithm 
\cite{akhremtsev2017engineering,fiduccia1988linear,sanchis1989multiple} (see Section 
\ref{sec:abs}). \\
An observation during the implementation of this framework was that only a minority
of the pairwise refinements based on flows yields to an improvement of the connectivity
metric on a hypergraph $H$. Therefore, we introduce several rules which might prevent
unnecessary flow executions to improve the effectiveness ratio by simultanously speed up
the runtime.

\begin{enumerate}
\item If the cut between two adjacent blocks in the quotient graph is small (e.g. $\le 10$) we
      skip the flow-based refinement on these blocks except on the last level of the hierarchy.
\item If the value of the cut of a minimum $(S,T)$-bipartition on $H_{V'}$ is the same 
      as the cut before, we stop the pairwise refinement on these blocks.
\item If a flow-based refinement did not lead to an improvement on two blocks in all levels
      of the multilevel hierarchy, we only execute flows in the first iteration of 
      \emph{Active Block Scheduling} on these blocks.
\end{enumerate}

\begin{figure}
\centering 
\includegraphics[width=1.0\textwidth]{../img/flow_local_search/flow_framework_hypergraph.eps}
\caption{Illustration of our flow-based refinement framework on hypergraphs.}
\label{img:flow_framework}
\end{figure} 