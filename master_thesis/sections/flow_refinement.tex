We now present our direct $k$-way \emph{flow}-based refinement framework. 
We use similiar techniques as proposed
by Sanders and Schulz \cite{sanders2011engineering}. 
The basic concepts of the framework are illustrated in \autoref{img:flow_framework}.
The algorithm can be integrated into a \emph{multilevel hypergraph partitioner} 
by executing the following algorithm in a level of the multilevel hierarchy.  \\
We perform a \emph{flow}-based refinement on two adjacent blocks of
a $k$-way partition $\Pi = \{V_1,\ldots,V_k\}$. The pairwise refinements are embedded 
into the \emph{active block scheduling} strategy (see Section \ref{sec:abs}).
The algorithm starts by constructing the quotient graph $Q$ of $\Pi$. 
Afterwards, we iterate over all edges of $Q$ in random order. For each edge
$(V_i,V_j)$ of $Q$, we build a flow problem around the cut of the bipartition
induced by $V_i$ and $V_j$. To construct the flow problem, we use two \BFS s. The first only 
touches hypernodes of $V_i$ and the second only touches hypernodes of $V_j$.
The \BFS~is initialized with all hypernodes contained in cut hyperedges
of the bipartition $(V_i,V_j)$. We will denote all hypernodes touched by 
the two \BFS s with $V' \subseteq V_i \cup V_j$.
We embed the pairwise \emph{flow}-based refinement
into an \emph{adaptive flow iteration} strategy
(as described in Section \ref{sec:adaptive_flow_iterations}), which also determines
the number of hypernodes touched by the two \BFS s. \\
We will use the subhypergraph $H_{V'}$ to construct one of the flow networks 
proposed in Section \ref{sec:opt_flow_network}. 
%Our \emph{Max-Flow-Min-Cut} computations operates on
%a subset of the hypergraph, because it reduces the running time of flow algorithms and
%increase the probability to find feasible partition according to our \emph{balanced constraint}.
We define the corresponding sources $S$
and sinks $T$ of the flow network of $H_{V'}$ in such way that a \emph{Max-Flow-Min-Cut} 
computation yields an improved $k$-way partition according to our objective function.
After we determine a maximum $(S,T)$-flow on the flow network, we iterate over
the minimum $(S,T)$-bipartitions of $H_{V'}$  and choose 
the \emph{Most Balanced Minimum Cut} according to our balance constraint
(as described in Section \ref{sec:related_mbmc}). \\
If a \emph{Max-Flow-Min-Cut} computation yields an improved partition of $H$, we apply
the new partition and execute the algorithm on the same blocks again, but double
the flow problem size according to the \emph{adaptive flow iteration} strategy. If
we cannot improve the partition, we decrease the flow problem size by a factor of $2$
and execute the algorithm on the same blocks again. The pairwise \emph{flow}-based
refinements stop if the \emph{adaptive flow iteration} scaling parameter $\alpha$ is
smaller than $1$ (see Section \ref{sec:adaptive_flow_iterations}).

\begin{figure}
\centering 
\includegraphics[width=1.0\textwidth]{../img/flow_local_search/flow_framework_hypergraph.eps}
\caption{Illustration of our \emph{flow}-based refinement framework for direct $k$-way hypergraph
         partitioning.}
\label{img:flow_framework}
\end{figure} 

\subsection{Flow Algorithms}
\label{sec:flow_algo_implementation}

We implement two maximum flow algorithms.
One is the \emph{augmenting path} algorithm of Edmond \& Karp (\EdmondKarp)
\cite{edmonds1972theoretical} 
and the second is the \emph{Push-Relabel} algorithm of
Goldberg \& Tarjan (\GoldbergTarjan) \cite{cherkassky1997implementing,goldberg1988new}. 
The \EdmondKarp~algorithm finds one \emph{augmenting path} with one \BFS~computation in each step.
Since we have a \emph{Multi-Source-Multi-Sink} problem, we can find several \emph{augmenting paths}
with one \BFS. After we execute a \BFS~on the residual graph, we search 
as many edge-disjoint paths as possible in the resulting \BFS-tree connecting a source $s$
with a sink $t$. Our Goldberg \& Tarjan implementation uses a \emph{FIFO} queue and
the \emph{global relabeling} and \emph{gap} heuristic \cite{cherkassky1997implementing}. \\
Further, we integrate two third-party maximum flow algorithms. The first algorithm is due to 
Boykov \& Kolmogorov \cite{boykov2004experimental} (\BoykovKolmogorov
\footnote{Available at \url{https://github.com/gerddie/maxflow} (Accessed at 14.12.2017)})
and the second is the \emph{incremental breadth-first search} 
(\IBFS \footnote{Available at \url{http://www.cs.tau.ac.il/~sagihed/ibfs/code.html} (Accessed at 16.12.2017)})
algorithm of Goldberg et. al \cite{goldberg2015faster}.
Before we call the algorithms, we map our internal flow network representation to
the one of the third-party implementation. Afterwards, we map the flow of each edge back
to our flow network.


\subsection{Source and Sink Configuration}
\label{sec:source_and_sink}

Let $\Pi_1$ be the bipartition of a hypergraph \HypergraphDef.
In the following, we show how to configure the source set $S$ and sink set $T$ of the flow
network $T_L(H_{V'})$ of a subhypergraph $H_{V'}$ induced by $V' \subseteq V$. The goal is 
to improve $\Pi_1$ with a maximum $(S,T)$-flow calculation 
on $T_L(H_{V'})$ such that after applying the minimum 
$(S,T)$-bipartition of $H_{V'}$ to $H$ the resulting bipartition $\Pi_2$ has a 
cut less than or equal to the cut of $\Pi_1$. An important concept of this section will
be the definition of the following \emph{section hypergraph}. 

\begin{figure}
\centering
\includegraphics[width=1.0\textwidth]{../img/source_and_sink_set/extension.eps}
\caption{Illustration of the \emph{section hypergraph} $\SectionHypergraph$. Each hyperedge of the
         the hypergraph $H$ which is fully or partially contained in $H_{V'}$ is fully
         contained in $\SectionHypergraph$. The nodes not contained in the rectangle of the right figure
         are part of $V''$.}
\label{img:section_hypergraph}
\end{figure}

\begin{definition}[Extension of a Subhypergraph]
\label{def:sub_extension}
Given a subset $V' \subseteq V$ of a hypergraph $H = (V,E)$.
The section hypergraph $\SectionHypergraph := H \times (V' \cup V'')$ is a hypergraph
where $V''$ contains all pins $u \notin V'$ of hyperedges incident to a vertex 
$v \in V'$. More formally, 
\[V'' := \bigcup_{e \in I(V')} e \setminus V'\]
\end{definition}

$\SectionHypergraph$ can be seen as an \emph{extension} of subhypergraph $H_{V'}$. Each
hyperedge, which is partially or fully contained in $H_{V'}$ is fully contained in $\SectionHypergraph$
(see \autoref{img:section_hypergraph}). The source and sink set of $T_L(H_{V'})$ should be
chosen in such a way that the two conditions of following problem statement are satisfied:
%In the following, we will first define our source and sink set on flow network $T_L(\SectionHypergraph)$ such that
%each hypernode $v \in V''$ is either a source or sink node. We can show, that a maximum
%$(S,T)$-flow on $T_L(\SectionHypergraph)$ then improves a given bipartition $\Pi_1$ of $H$.
%Afterwards, we will remove all hypernodes $v \in V''$ of $T_L(\SectionHypergraph)$ with
%Theorem \ref{theorem:heuer_network} which will result in a source set $S'$ and sink 
%set $T'$ for $T_L(H_{V'})$. Moreover, the value of a maximum $(S,T)$-flow of $T_L(\SectionHypergraph)$
%and a maximum $(S',T')$-flow of $T_L(H_{V'})$ will be the same. \\
%We introduce the \emph{section hypergraph} $\SectionHypergraph$ because we have to redefine the defintion
%of the cut of $H_{V'}$ related to a bipartition $\Pi$ of $H$ as follows:
%\begin{equation}
%\label{eq:sub_cut}
%\omega_{H_{V'}}(\Pi) := \omega_{\SectionHypergraph}(\Pi)
%\end{equation}
%Note, that the cut $\omega_{H_{V'}}$ is defined over the cut nets of $H$ (which are equal to 
%the cut nets of $\SectionHypergraph$). A cut hyperedge $e$ of $H$ is not necessarily a cut hyperedge
%of $H_{V'}$. For example, if $e = \{v_1,v_2\}$ is a hyperedge with $v_1 \in V_1$ and $v_2 \in V_2$ and
%$v_1 \in V'$ and $v_2 \notin V'$, then $e$ is cut in $H$, but not in $H_{V'}$, because
%$v_2$ is not contained in $H_{V'}$. The reason that we still
%define $e$ as cut hyperedge of $H_{V'}$ has to do with our problem statement, 
%which we will define as follows:

\begin{problem}
\label{prob:ST} 
Given a subhypergraph $H_{V'}$ ($V' \subseteq V$) and bipartition $\Pi_1$ of hypergraph $H$.
How should $S$ and $T$ be defined such that after a maximum $(S,T)$-flow calculation on $T_L(H_{V'})$ (with 
$f$ as maximum flow) the resulting minimum $(S,T)$-bipartition $\Pi_2$ of $H$ satisfies
the following conditions:
\begin{enumerate}
\item $\omega_H(\Pi_2) \le \omega_H(\Pi_1)$
\item $\Delta_{H} := \omega_H(\Pi_1) - \omega_H(\Pi_2) = \omega_{\SectionHypergraph}(\Pi_1) - |f| =: \Delta_{H_{V'}}$
\end{enumerate}
\end{problem}

The first condition ensures that a \emph{Max-Flow-Min-Cut} computation on $T_L(H_{V'})$ never 
increases the cut of $H$, while the second condition allows us to update the cut metric in
constant time via $\omega_H(\Pi_2) = w_H(\Pi_1) - \Delta_{H_{V'}}$, instead of having 
to sum up the weight of all cut hyperedges. Since we have to build the subhypergraph
$H_{V'}$ before each maximum flow computation, we can implicitly calculate $\omega_{\SectionHypergraph}(\Pi_1)$.\\
Note that we define $\Delta_{H_{V'}}$ over the cut of the \emph{section hypergraph} $\SectionHypergraph$.
If only hypernodes contained in $V'$ can change their block after a \emph{Max-Flow-Min-Cut} computation
then the equality
\[\Delta_{H} := \omega_H(\Pi_1) - \omega_H(\Pi_2) = \omega_{\SectionHypergraph}(\Pi_1) - \omega_{\SectionHypergraph}(\Pi_2) =: \Delta_{H_{V'}}\]
holds, because all hyperedges, which can change their state from non-cut to cut or vice versa, are
fully contained in $\SectionHypergraph$. For example, if a \emph{Max-Flow-Min-Cut} computation
on $H_{V'}$ removes hyperedge $e$ from the cut in $H_{V'}$, but $e$ is still cut in
$H$, then the equality would not hold if we would have defined $\Delta_{H_{V'}}$ over the cut
of $H_{V'}$, because $\Delta_{H_{V'}}$ would be equal to $1$ and $\Delta_{H}$
equal to $0$. Further, if we can show that $|f| = \omega_{\SectionHypergraph}(\Pi_2)$, 
we simultaneously show that our source and sink set modeling approach satisfies condition (ii) 
$\Delta_H = \Delta_{H_{V'}}$. \\
We will now define our source and sink set for the flow network $T_L(H_{V'})$ such that
we satisfy the two conditions of Problem \ref{prob:ST}.
\begin{theorem}
\label{theorem:ST}
Let $\Pi_1 = (V_1,V_2)$ be the bipartition of $H$. The resulting bipartition $\Pi_2$ 
of $H$ of a maximum $(S,T)$-flow computation on $T_L(H_{V'})$ with
\begin{align*}
S = \{\incoming{e}\ |\ e \in I(V'' \cap V_1)\} \\
T = \{\outgoing{e}\ |\ e \in I(V'' \cap V_2)\} 
\end{align*}
satisfies the following two conditions:
\begin{enumerate}
\item $\omega_H(\Pi_2) \le \omega_H(\Pi_1)$
\item $\Delta_H = \Delta_{H_{V'}}$
\end{enumerate}
\end{theorem}

\begin{proof}
We will first define $S$ and $T$ for flow network
$T_L(\SectionHypergraph)$, because for each maximum $(S,T)$-flow $f$ of $T_L(\SectionHypergraph)$
and its corresponding minimum $(S,T)$-bipartition $\Pi_2$ the equality 
$|f| = \omega_{\SectionHypergraph}(\Pi_2)$ holds due to the 
\emph{max-flow-min-cut} theorem \cite{ford1956maximal}. 
Defining a hypernode $v \in V_1$ resp. $v \in V_2$ as source resp. sink means that
it cannot change its block after a \emph{Max-Flow-Min-Cut} computation.
However, we do not want that a hypernode $v \notin V'$ can change its block after
a \emph{Max-Flow-Min-Cut} computation on $T_L(\SectionHypergraph)$, because such hypernodes
cannot move if we solve a flow problem on subhypergraph $H_{V'}$. Therefore, we define
all hypernodes of $V''$ contained in block $V_1$ as sources and all hypernodes of $V''$ contained
in block $V_2$ as sinks. More formally:
\begin{align*}
S' = V'' \cap V_1 \\
T' = V'' \cap V_2 
\end{align*}
With $S'$ and $T'$ we ensure that only hyperedges fully contained in $S_{V'}$ can
change their state from cut to non-cut or vice versa. Therefore, it follows with
the \emph{max-flow-min-cut} theorem \cite{ford1956maximal} that $|f| = \omega_{\SectionHypergraph}(\Pi_2)
\le \omega_{\SectionHypergraph}(\Pi_1)$ and 
\[\Delta_{H} = \omega_H(\Pi_1) - \omega_H(\Pi_2) = \omega_{\SectionHypergraph}(\Pi_1) - |f| = \Delta_{H_{V'}} \ge 0 \text{,}\]
because only hypernodes contained in $V'$ can change their block. Since $\Delta_H \ge 0$,
it holds that $\omega_H(\Pi_2) \le \omega_H(\Pi_1)$.\\
%We will now define the source and sink set of $T_L(H_{V'})$, which will be a consequence
%of the proof of Theorem \ref{theorem:ST}.
%\begin{align}
%S' = \{\incoming{e}\ |\ e \in I(S)\} \label{eq:S}\\
%T' = \{\outgoing{e}\ |\ e \in I(T)\} \label{eq:T}
%\end{align}
%For a source node $s \in S$ resp. sink node $t \in T$ of $T_L(\SectionHypergraph)$ 
%we define the corresponding \emph{incoming} resp. \emph{outgoing}
%hyperedge nodes of all incident hyperedges $e \in I(s)$ resp. $e \in I(t)$ as 
%source resp. sink nodes of $T_L(H_{V'})$.\\
The value of a maximum $(S',T')$-flow of $T_L(\SectionHypergraph)$ is equal to the value of a maximum
$(S,T)$-flow of $T_H(\SectionHypergraph,V'')$ according to Theorem \ref{theorem:heuer_network}
with
\begin{align*}
S = \overbrace{S' \setminus V''}^{= \emptyset}\ \cup \bigcup\limits_{e \in I(\underbrace{\scriptstyle V'' \cap S'}_{= V'' \cap V_1})} \{\incoming{e}\} = \{\incoming{e}\ |\ e \in I(V'' \cap V_1)\} \\
T = \overbrace{T' \setminus V''}^{= \emptyset}\ \cup \bigcup\limits_{e \in I(\underbrace{\scriptstyle V'' \cap T'}_{= V'' \cap V_2})} \{\outgoing{e}\} = \{\outgoing{e}\ |\ e \in I(V'' \cap V_2)\}
\end{align*}
Since each $v \in V''$ is either a source or sink node of $T_L(\SectionHypergraph)$, the 
removal of $v$ does not induce any additional edges in $T_H(\SectionHypergraph,V'')$
(see Lemma \ref{lemma:source_and_sink_removal}). Therefore,
$T_H(\SectionHypergraph,V'') = T_L(H_{V'})$.
\end{proof}

The value of a maximum $(S',T')$-flow of $T_L(\SectionHypergraph)$ and a maximum $(S,T)$-flow
of $T_L(H_{V'})$ are equal. Since $S'$ and $T'$ satisfy conditions (i) and (ii) of our 
problem statement, also $S$ and $T$ satisfy the two conditions. 
In general, each hyperedge partially contained in $H_{V'}$, which contains at least one pin
$v \notin V'$ of block $V_1$ resp. $V_2$ is a source resp. sink node. Furthermore, no hypernode
of $T_L(H_{V'})$ is either a source or sink node. Consequently, all hypernodes of $V'$
can change their block after a \emph{Max-Flow-Min-Cut} computation. According to the 
\emph{max-flow-min-cut} theorem, the value of the cut of bipartition $\Pi_2$ is the minimum
weight cut of all possible bipartitions with the restriction that only hypernodes of $V'$ can move.\\
\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/edge_size_two.eps}
\caption{Illustration of modeling hyperedges of size one of the flow network
         if the incoming or outgoing hyperedge node is a source or a sink node 
         of the flow problem.}
\label{img:edge_size_two}
\end{figure}
%Further, we can reduce the number of nodes and edges, if model each edge which is fully contained
%in $H_{V'}$ as graph edge according to Lemma \ref{lemma:undirected_transformation}. Each edge
%partially contained in the flow problem is modeled as hyperedge of size one (see \autoref{img:edge_size_two}).
Additionally, we can model hyperedges of size one more efficiently (see \autoref{img:edge_size_two}).
If the incoming hyperedge node $\incoming{e}$ is a source node, we can replace the hyperedge of
size one with a directed edge $(\incoming{e},v)$ with $v \in e \cap V'$ and capacity $\omega(e)$.
If the outgoing hyperege node $\outgoing{e}$ is a sink node, we add a directed edge
$(v,\outgoing{e})$ with capacity $\omega(e)$. If $\incoming{e}$ and $\outgoing{e}$ is neither a source
nor sink node, we can remove the hyperedge from the flow problem. \\
With the given approach we can optimize the cut metric of a given
bipartition of a hypergraph $H$. We can transfer those results to improve the connectivity metric
of a $k$-way partition $\Pi = (V_1,\ldots,V_k)$. 
Let $V' \subseteq V_i \cup V_j$ be a subset of the hypernodes of two adjacent
blocks $V_i$ and $V_j$. If we optimize the cut of
subhypergraph $H_{V'}$ we simultaneously optimize the connectivity metric of $H$.
The reduction of the cut of $H_{V'}$ is then equal with the decrease in
the connectivity metric of $H$.

\fakepar{Implications for Graph Partitioning.}
\normalfont\normalsize
If we compare our source and sink set modeling approach with the one of Sanders and Schulz
\cite{sanders2011engineering} (see Section \ref{sec:balanced_bipartitioning}), we can show that
with our technique better minimum $(S,T)$-bipartitions are achievable. They define each node of the graph
as source resp. sink, which is adjacent to a node not contained in the flow problem of block $V_1$
resp. $V_2$. Consequently, a non-cut edge of the graph partially contained in the flow problem
cannot become a cut edge. Therefore, their modeling approach satisfies condition (i) of our problem
statement. However, a movement of a node adjacent to a non-cut edge can still improve the cut, if
the number of adjacent non-cut edges is smaller than the number of adjacent cut edges. 
If we interprete a graph as hypergraph, we can use our modeling 
approach on network $T_L(H_{V'})$ or $T_G(H_{V'})$ with $S$ and $T$ as source and sink set. 
All nodes incident to a non-cut edge which is partially contained in the flow problem
are now able to change their block and the corresponding minimum $(S,T)$-bipartition is minimum
among all possible bipartitions where only nodes of $V'$ can move.

%\begin{figure}[ht!]
%\centering
%\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/st_modelling_summary.eps}
%\caption{Illustration of modeling sources and sinks defined in Equation \ref{S_border_hyperedges}
%         and \ref{T_border_hyperedges}. }
%\label{img:st_modelling_summary}
%\end{figure}

\subsection{Most Balanced Minimum Cuts on Hypergraphs}
\label{sec:mbmc_hypergraphs}

Picard and Queyranne \cite{picard1980structure} show that all minimum $(s,t)$-cuts 
of a graph $G$ are computable with one maximum $(s,t)$-flow computation by 
iterating through all \emph{closed node sets} of the residual graph of $G$. \\
We can apply the same algorithm on hypergraphs. A minimum-capacity $(s,t)$-cutset of \ShortT{L}
is equal with a minimum-weight $(s,t)$-cutset of $H$. With the algorithm
of Section \ref{sec:related_mbmc} we can find all minimum-capacity
$(s,t)$-cutsets of \ShortT{L}, which are also minimum-weight $(s,t)$-cutsets
of $H$. The corresponding minimum-weight $(s,t)$-bipartitions are all
\emph{closed node sets} of the residual graph of \ShortT{L}. 
However, when we use e.g., \ShortExT{H}{V'} (see Section \ref{sec:heuer_network})
or \ShortHybrid~(see Section \ref{sec:hybrid_network}) as underlying flow network,
some hypernodes are removed from the flow problem. If an
\emph{outgoing} hyperedge node $\outgoing{e}$ is part of a \emph{closed node set}, than
all hypernodes $v \in e$ must be part of it too, which is a consequence of Lemma \ref{lemma:bipartition_construction}. 
The \emph{Most Balanced Minimum Cut} heuristic consists of many stages, which we then have to adapt if we enumerate the minimum-weight
$(S,T)$-bipartitions. Since the algorithm has a linear running time, we simply reinsert all
removed hypernodes with the corresponding edges of the Lawler-Network before computing 
the \emph{Most Balanced Minimum Cut}. 
\begin{lemma}
Let $T_L(H) = (V,E_L,\capa_L)$ be the Lawler-Network and $T_H(H,V') = (V \setminus V', E_H, \capa_H)$ be the
flow network proposed in Section \ref{sec:heuer_network} of hypergraph \HypergraphDef~with $V' \subseteq V$.
If $f$ is a maximum $(S,T)$-flow of $T_H(H,V')$, then $f$ is also a maximum $(S,T)$-flow of the
flow network $T = (V, E_L \cup E_H, \capa)$ with $\capa(v,w) = \capa_L(v,w)$, if
$(v,w) \in E_L$ and $\capacity{v,w} = \capa_H(v,w)$, otherwise.
\end{lemma}
\begin{proof}
The main statement of the lemma is that we can calculate a maximum $(S,T)$-flow $f$ of 
\ShortExT{H}{V'} and then reinsert all removed hypernodes with their corresponding edges of the Lawler-Network.
The flow $f$ is also a maximum $(S,T)$-flow on the resulting flow network $T$.
Assume, that there still exists an \emph{augmenting path} in the residual graph of $T$.
If we remove a hypernode $v$ from the flow network $T_L(H)$, we insert \emph{shortcut} edges
between all incident hyperedges $e \in I(v)$. However, if the \emph{augmenting path} $P = (s,\ldots,\outgoing{e_1},v,\incoming{e_2},\ldots,t)$
contains a reinserted hypernode $v \in V'$, we can simply remove it from the path. 
After removing all $v \in V'$ from $P$, we obtain a valid path in $T_H(H,V')$. 
The resulting path then contains the \emph{shortcut} edges $(\outgoing{e_1},\incoming{e_2})$
instead of the two inserted edges $(\outgoing{e_1},v)$ and $(v,\incoming{e_2})$. All involved edges
have capacity equal to $\infty$. Therefore, it must be an \emph{augmenting path} in $T_H(H,V')$, 
which is a contradiction that $f$ is a maximum $(S,T)$-flow.
\end{proof}

Consequently, if we remove a hypernode from the flow network, we can reinsert it with the
corresponding incident edges of the Lawler-Network after a maximum $(S,T)$-flow computation.
All minimum $(S,T)$-cutsets of the resulting flow network $T$  have the same value as all minimum
$(S,T)$-cutsets of \ShortExT{H}{V'}, because the value of a maximum $(S,T)$-flow is the same in both networks.


\subsection{Integration into KaHyPar}
\label{sec:integration_kahypar}  

\fakepar{Flow Execution Policies.}
\normalfont\normalsize
Since \emph{KaHyPar} is an $n$-level hypergraph partitioner, local searches
are executed after each uncontraction of a single vertex (see Section \ref{sec:kahypar}). 
Using our \emph{flow}-based refinement algorithm in each level would be too expensive.
Therefore, we introduce \emph{Flow Execution Policies}, which control total number of
\emph{flow}-based refinements throughout the multilevel hierarchy. The first policy is to 
execute our \emph{flow}-based refinement on each level $i$ where $i = \beta\cdot j$ with 
$j \in \mathbb{N}_+$ and $\beta$ as a predefined tuning parameter. Another approach is to simulate a
multilevel partitioner with $\log(n)$ hierarchies. A \emph{flow}-based refinement is then
executed on each level $i$ where $i = 2^j$ with $j \in \mathbb{N}_+$. Each policy also
performs the \emph{active block scheduling} refinement strategy on the last level of the
hierarchy. In all remaining levels where no flow is executed, we can use an 
\emph{FM} algorithm 
\cite{akhremtsev2017engineering,fiduccia1988linear,sanchis1989multiple} (see Section 
\ref{sec:abs}). 

\fakepar{Combining Flow-Based Refinements with the FM algorithm.}
\normalfont\normalsize
The \emph{FM} algorithms integrated into \emph{KaHyPar} use a \emph{gain cache} to maintain
the gain values of moves througout the multilevel hierarchy. The concept prevents expensive recalculations
of gain values if a \emph{FM} local search is instantiated. However, if we use \emph{flow}-based
refinement in combination with the \emph{FM} algorithm, we have to ensure that the 
\emph{gain cache} contains valid entries at each time. Therefore, we undo all changes after a \emph{flow}-based
refinement and simulate the moves with the \emph{FM} algorithm to ensure that all entries in
the \emph{gain cache} are valid.

\fakepar{Speedup Heuristics.}
\normalfont\normalsize
An observation during early experiments was that only a minority
of the pairwise refinements based on flows leads to an improvement
on hypergraph $H$. Thus, we introduce several rules which help to prevent
\emph{unpromising} flow executions to speed-up the running time.

\begin{enumerate}
\item[(R1)] The \emph{acitve block scheduling} refinement strategy is executed in rounds. In each
            round we use \emph{flows} to improve the bipartition of two adjacent blocks, where 
            one of the two is \emph{active}. Initially, all blocks are \emph{active}. 
            A block becomes \emph{inactive}, if its border does not change in a round. 
            However, we introduce a second criterion when to use \emph{flow}-based refinement
            on two adjacent blocks. For each pair of adjacent blocks, we count how
            many times we found an improvement on these blocks throughout the multilevel hierarchy.
            The first round of \emph{active block scheduling} is executed as before. In all remaining
            rounds, we only execute a pairwise \emph{flow}-based refinement, if one of the two 
            blocks is \emph{active} and if we found at least one improvement before on the
            corresponding blocks.
\item[(R2)] If the cut between two adjacent blocks is small (e.g. $\le 10$) we
            skip the \emph{flow}-based refinement on the blocks except on the last level of the hierarchy.
\item[(R3)] If the value of the cut of a minimum $(S,T)$-bipartition of $H_{V'}$ is the same 
            as the cut before, we stop the \emph{adaptive flow iteration} strategy.
\end{enumerate}

% First Version of Section 5.1

%An example of a \emph{Max-Flow-Min-Cut} computation of $H_{V'}$ with $S$ and $T$ as source and
%sink set is illustrated in \autoref{img:border_hyperedges}.
%\begin{figure}
%\centering
%\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/border_hyperedges.eps}
%\caption{Non-cut \emph{border hyperedges} of $H$ and $H_{V'}$ induce source and sink hypernodes
%         in the flow problem.}
%\label{img:border_hyperedges}
%\end{figure}
%
%\begin{lemma}
%\label{cut_decrease_proof}
%Let $\Pi_1$ be a bipartition of $H$ and $T_L(H_{V'})$ the flow network of subhypergraph
%$H_{V'}$ with $S$ and $T$ as defined in Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges} (with $V' \subseteq V$).
%If $\Pi_2$ is a bipartition obtained by a maximum $(S,T)$-flow computation on $T_L(H_{V'})$,
%then the inequality $\omega_H(\Pi_2) \le \omega_H(\Pi_1)$ holds.
%\end{lemma}
%
%\begin{proof}
%A maximum $(S,T)$-flow computation on $T_L(H_{V'})$ yields a minimum $(S,T)$-cutset on 
%$H_{V'}$ \cite{ford1956maximal}. Thus, for all hyperedges $e \notin \delta B$ (fully contained in $H_{V'}$)
%which are cut in $\Pi_2$, the sum of their weight must be less or equal than the sum of all cut hyperedges
%$e \notin \delta B$ of bipartition $\Pi_1$. We have to show that a non-cut
%hyperedge $e \in \delta B_1$ of $\Pi_1 = (V_1,V_2)$ cannot become a cut hyperedge of
%$\Pi_2 = (V_1',V_2')$. Let $e \in \delta B_1$ be such a hyperedge. $e$ must be either a subset of $V_1$ or $V_2$, otherwise
%$e$ is a cut hyperedge. Let $e \subseteq V_1$, then $e \cap V' \subseteq S$ (see Equation \ref{S1_border_hyperedges}). 
%Defining a node $s \in S$ as source node means that it cannot change its block after a \emph{Max-Flow-Min-Cut}
%computation. Therefore, $e \subseteq V_1$ and $e \subseteq V_1' \Rightarrow e$ is a non-cut
%hyperedge of $\Pi_2$. The proof for $e \subseteq V_2$ is equivalent $\Rightarrow \omega_H(\Pi_2) 
%\le \omega_H(\Pi_1)$.
%\end{proof} 
%\begin{figure}[ht!]
%\centering
%\includegraphics[width=1.0\textwidth]{../img/source_and_sink_set/non_cut_flow_hyperedges.eps}
%\caption{In this example $e_1$ and $e_3$ are cut hyperedges of the hypergraph, but non-cut nets
%        of subhypergraph $H_{V'}$. Modeling the \emph{outgoing} resp.
%        \emph{incoming} hyperedge node of $e_1$ resp. $e_2$ as sink resp. source ensures
%        that $\Delta_H = \Delta_{H_{V'}}$.} 
%\label{img:non_cut_flow_hyperedges}
%\end{figure}
%
%In the next step, we will show how $S$ and $T$ can be extended to satisfy condition (ii)
%of Problem \autoref{prob:ST}. Currently, $|f| \le \omega_{H_{V'}}(\Pi_2)$ (without a prove).
%Obviously, some nodes are missing in $S$ and $T$. Consider \autoref{img:non_cut_flow_hyperedges}
%to understand which nodes are missing. Transformation $1$ illustrates our current modeling
%approach defined in Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges}. The maximum
%flow on this network is $|f| = 1$, but the resulting minimum $(S,T)$-bipartition $\Pi_2$ induce
%a cut of $\omega_{H}(\Pi_2) = 2$. This implies that $\Delta_H = 3 - 2 \neq 3 - 1 = \Delta_{H_{V'}}$.
%The hyperedges $e_1$ and $e_3$ are cut nets of $H$, but non-cut hyperedges of $H_{V'}$. 
%Therefore, $\Pi_1$ induce a cut of $1$ on $H_{V'}$ if we define the cut $\omega_{H_{V'}}(\Pi_2)$
%over the cut hyperedges of $H_{V'}$ instead of the cut hyperedges of $H$. In our example, we can
%remove $e_2$ from cut, but $e_1$ becomes a cut hyperedge of $H_{V'}$. Therefore, the value of the
%cut of $H_{V'}$ does not change, but the cut of $H$ does. $e_1$ is already a cut hyperedge of $H$ and $\Pi_2$ removes
%$e_2$ from the cut of $H$. Therefore, $\Delta_H = 1$. However, we defined $\omega_{H_{V'}}(\Pi_2)$
%over the cut hyperedges of $H$ and currently, we hvae $|f| = 1 \neq 2 = \omega_{H_{V'}}(\Pi_2)$. \\
%Transformation $2$ illustrates the adapted modeling approach for cut hyperedges of $H$.
%For each hyperedge $e \in \delta B_2$ with $e \setminus V' \cap V_1 \neq \emptyset$, 
%we add the \emph{incoming hyperedge node} $\incoming{e}$ to $S$.
%More formal:
%\begin{align}
%S = S_1 \cup \{\incoming{e} \in \delta B_2\ |\ e \setminus V' \cap V_1  \neq \emptyset\} \label{S_border_hyperedges}\\
%T = T_1 \cup \{\outgoing{e} \in \delta B_2\ |\ e \setminus V' \cap V_2 \neq \emptyset \} \label{T_border_hyperedges}
%\end{align}
%
%We have to show that for a maximum $(S,T)$-flow $f$ of $T_L(H_{V'})$ holds $|f| = \omega_{H_{V'}}(\Pi_2)$.
%The idea of the proof is to use the extension $\SectionHypergraph$ of $H_{V'}$ and add 
%all $V'' \cap V_1$ to $S_1$ (see Equation \ref{S1_border_hyperedges}) and all $V'' \cap V_2$ to
%$T_1$ (see Equation \ref{T1_border_hyperedges}). We can show that for a maximum $(S_1,T_1)$-flow 
%$f'$ of $T_L(\SectionHypergraph)$ holds that $|f'| = \omega_{H_{V'}}(\Pi_2)$.\\
%Afterwards, we use a technique to remove all $v \in V''$ of $T_L(\SectionHypergraph)$ and show
%that the resulting flow network is $T_L(H_{V'})$ with $S$ and $T$ as source and sink set as
%defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges}. Moreover, for a maximum
%$(S,T)$-flow $f$ then holds that $|f| = |f'| = \omega_{H_{V'}}(\Pi_2)$. \\
%Because of the complexity of the proof, we will introduce lemmas in the following which
%will simplify the proof of the main theorem. Consider \autoref{img:general_source_and_sink}~if you
%need an illustration for the following lemmas.
%
%\begin{figure}
%\centering
%\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/general_source_and_sink.eps}
%\caption{Illustration of the proof technique used in Lemma \ref{lemma:general_source_and_sink_removal}.
%         The green node $s$ is the super source of the flow problem. The blue nodes are source nodes of
%         the corresponding \emph{multi-source multi-sink} flow problem. The red nodes $u$ and $v$ are
%         contained in $\mathcal{R}(s_2)$. Therefore, edges $(s_2,u)$ and $(s_2,v)$ are removable.}
%\label{img:general_source_and_sink}
%\end{figure}
%
%\begin{lemma}[Source Edge Removal]
%\label{lemma:source_edge_removal}
%Let $f$ be a maximum $(S,T)$-flow of $G = (V,E,\capa)$. If there exists two edges $(s_1,v)$ and $(s_2,v)$
%with infinite capacity ($s_1,s_2 \in S$) we can either remove $(s_1,v)$ or $(s_2,v)$ from $G$
%without changing the amount of a maximum $(S,T)$-flow.
%\end{lemma}
%
%\begin{proof}
%Let $P = (s_1,v,\ldots)$ be an augmenting path of $G$. Replacing $s_1$ in $P$ with $s_2$ yields
%an augmenting path $P'$ of same length. The operation is valid because $\capacity{s_1,v} = \capacity{s_2,v} = \infty$. 
%If we execute Edmond and Karp's maximum flow algorithm we can map each augmenting path 
%$P$ to $P'$ and ensure that for a maximum $(S,T)$-flow $f$ follows that $f(s_1,v) = 0$. 
%Consequently, there exists maximum $(S,T)$-flows where either $f(s_1,v) = 0$ or $f(s_2,v) = 0$.
%Therefore, we can remove either $(s_1,v)$ or $(s_2,v)$ without changing the amount of
%a maximum $(S,T)$-flow.
%\end{proof}
%
%\begin{lemma}[Sink Edge Removal]
%\label{lemma:sink_edge_removal}
%Let $f$ be a maximum $(S,T)$-flow of $G$. If there exists two edges $(v,t_1)$ and $(v,t_2)$
%with infinite capacity ($t_1,t_2 \in T$) we can either remove $(v,t_1)$ or $(v,t_2)$ from $G$
%without changing the amount of a maximum $(S,T)$-flow.
%\end{lemma}
%
%\begin{proof}
%Equivalent to proof of Lemma \ref{lemma:source_edge_removal}.
%\end{proof}
%
%\begin{definition}[Removable Edges]
%We denote the set of all adjacent nodes $v$ of a source node $s$ resp. sink node $t$, where
%edge $(s,v)$ or $(v,t)$ is removable according to Lemma \ref{lemma:source_edge_removal}
%and \ref{lemma:sink_edge_removal}, with $\mathcal{R}(s)$ resp. $\mathcal{R}(t)$.
%\end{definition}
%
%The following lemma is a generalisation of Lemma \ref{lemma:source_and_sink_removal}. We will use
%the definition of $in(u)$ and $out(u)$ presented in Section \ref{sec:heuer_network}. Further,
%$G_{V'}$ is a subgraph of $G = (V,E)$ induce by $V' \subseteq V$ (see definition \ref{def:subgraph}).
%
%\begin{lemma}[General Source/Sink Node Removal]
%\label{lemma:general_source_and_sink_removal}
%Let $f$ be a maximum $(S,T)$-flow of $G = (V,E,\capa)$ with $|f| < \infty$ and
%$E_s \subseteq \mathcal{R}(s)$ and $E_t \subseteq \mathcal{R}(t)$ with $s \in S$
%and $t \in T$.
%If $s$ is a source node where all outgoing edges have infinte capacity and
%$t$ is a sink node where all incoming edges have infinte capacity, then
%$|f|$ is equal with the amount of a maximum $(S',T)$-flow of $G_{V\setminus \{s\}}$ and a maximum
%$(S,T')$-flow of $G_{V\setminus \{t\}}$, where $S' = (S\setminus \{s\}) \cup (out(s) \setminus E_s)$ 
%and $T' = (T \setminus \{t\}) \cup (in(t) \setminus E_t)$.
%\end{lemma}
%
%\begin{proof}
%$E_s$ is an arbitrary subset of $\mathcal{R}(s)$, where foreach $v \in E_s$ the edge $(s,v)$ is removable.
%$S'$ is the source set without node $s$ extended with all outgoing edges of 
%$s$ minus the removable edges $E_s$. With Lemma \ref{lemma:source_edge_removal}
%we can remove all edges $(s,v)$ with $v \in E_s$ from $G$ and obtain flow network $G'$. Finally, we can
%apply Lemma \ref{lemma:source_and_sink_removal} on $G'$ and obtain $G_{V\setminus \{s\}}$ with $(S',T)$ as source
%and sink set (see \autoref{img:general_source_and_sink}). All used Lemma's did not change the amount of a maximum flow. Therefore, a maximum
%$(S,T)$-flow of $G$ is equal with a maximum $(S',T)$-flow of $G_{V\setminus \{s\}}$. The proof for $t$ is
%equivalent.
%\end{proof}
%
%The proof of Lemma \ref{cut_decrease_proof} can be applied one-to-one on our new source and
%sink sets because $S_1 \subseteq S$ and $T_1 \subseteq T$. Therefore, $S$ and $T$ 
%as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges} satisfies
%condition (i) of Problem \ref{prob:ST}. We will show that for $S$ and $T$ 
%the equality $\Delta_H = \Delta_{H_{V'}}$ holds.
%
%\begin{theorem} 
%\label{lemma:delta_proof}
%Let $\Pi_1 = (V_1,V_2)$ be a bipartition of $H$ and $T_L(H_{V'})$ the flow network of subhypergraph
%$H_{V'}$ with $S$ and $T$ as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges} (with $V' \subseteq V$).
%If $\Pi_2$ is a bipartition obtained by a maximum $(S,T)$-flow computation on $T_L(H_{V'})$
%with $f$ as maximum flow,
%then $\omega_{H_{V'}}(\Pi_2) = |f|$ ($\Rightarrow \Delta_H = \Delta_{H_{V'}}$).
%\end{theorem}
%
%\begin{proof}
%Consider the extension $\SectionHypergraph$ of subhypergraph $H_{V'}$ (see Definition \ref{def:sub_extension}).
%Each maximum $(S,T)$-flow $f'$ of $T_L(\SectionHypergraph)$ is then equal with a minimum-weight
%$(S,T)$-cutset of $H_{V'}$ according to our definition of the cut $\omega_{H_{V'}}(\Pi_2)$ over
%the cut hyperedges of $H$. Because each hyperedge which is partially contained in $H_{V'}$
%is fully contained in $\SectionHypergraph$. Therefore, it holds that $|f'| = \omega_{H_{V'}}(\Pi_2)$.
%However, we have to model some restrictions into our source and sink set of $T_L(\SectionHypergraph)$.
%We will denote the source and sink set of $T_L(\SectionHypergraph)$ with $S'$ and $T'$.
%Each hypernode contained in a non-cut border hyperedge $e \in \delta B_1$ should not be able to move
%such that we ensure that $e$ is not cut after a maximum $(S',T')$-flow calculation. Therefore,
%we add $S_1$ and $T_1$ to $S'$ and $T'$ (see Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges}).
%Further, all hypernodes $v \in V''$ (see definition \ref{def:sub_extension}) are not contained in
%$H_{V'}$. Consequently, they cannot change their block if we calculate a maximum $(S,T)$-flow of
%$T_L(H_{V'})$. Therefore, we add $V'' \cap V_1$ to $S'$ and $V'' \cap V_2$ to $T'$.
%With $S'$ and $T'$ as source and sink set we ensure that only hypernodes $v \in V'$ are able
%to move and since $S_1 \subseteq S'$ and $T_1 \subseteq T'$, we ensure that $\omega_H(\Pi_2) \le \omega_H(\Pi_1)$
%(see Lemma \ref{cut_decrease_proof}). \\
%In the following, we apply Lemma \ref{lemma:general_source_and_sink_removal} on all
%hypernodes $v \in V''$ such that the flow network $T_L(\SectionHypergraph)$ converge against
%$T_L(H_{V'})$ with $S$ and $T$ as source and sink set as defined in Equation 
%\ref{S_border_hyperedges} and \ref{T_border_hyperedges} \emph{without} changing the
%amount of the maximum flow $f'$. Since $|f'| = \omega_{H_{V'}}(\Pi_2)$, for a maximum $(S,T)$-flow
%$f$ of $T_L(H_{V'})$ then holds $|f| = \omega_{H_{V'}}(\Pi_2)$. Per definition a node $v \in V''$
%is either a source or sink node. For each source node $s \in V''$ we have to 
%define a removable subset $E_s \subseteq \mathcal{R}(s)$ such that after removing all $s \in S' \cap V''$
%the resulting source set $S$ is equal to Equation \ref{S_border_hyperedges}. The technique
%for removing each sink node $t \in S' \cap V''$ will be equivalent. For a source node $s \in V''$
%we define $E_s = \{\incoming{e}\ |\ e \in I(s) \cap \delta B_1\}$. Remember, $\delta B_1$ contains
%all non-cut border hyperedges of $H$. Thus, for each $e \in I(s) \cap \delta B_1$ exists
%a source node $\bar{s} \in V'$ of $S_1$ such that edges $(s,\incoming{e})$ and $(\bar{s},\incoming{e})$
%are contained in $T_L(\SectionHypergraph)$ (see \autoref{img:delta_proof_illustration}). Therefore, $E_s$ is a removable subset of $\mathcal{R}(s)$.
%For each $t \in T' \cap V''$ we define the removable subset $E_t = \{\outgoing{e}\ |\ e \in I(t) \cap \delta B_1\}$.
%Applying Lemma \ref{lemma:general_source_and_sink_removal} on all source nodes $s \in V''$
%with $E_s$ as removable subset and on all sink nodes $t \in V''$ with $E_t$ 
%as removable subset yield flow network $T_L(H_{V'})$ with $S$ and $T$ as source and sink 
%set as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges}.
%A hyperedge $e \in \delta B_1$ cannot become a source or sink node because if we remove a 
%source node $s \in e$ then $e'$ is in the removable subset $E_s$ (see \autoref{img:delta_proof_illustration}). The same holds
%for each sink node $t \in V''$. A hyperedge $e \in \delta B_2$ becomes a source node of $S$
%if we remove a source node $s \in e$ and a sink node of $T$ if we remove a 
%sink node $t \in e$ because $\forall e \in \delta B_2: e',e'' \notin E_s \cup E_t$. 
%Therefore, $S$ and $T$ are equal to our source and sink set definition and
%for a maximum $(S,T)$-flow $f$ it holds that $|f| = |f'| = \omega_{H_{V'}}(\Pi_1)$.
%\end{proof}
%
%\begin{figure}
%\centering
%\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/delta_proof_illustration.eps}
%\caption{Illustration how to remove a source node $v \in V''$. Note, the green node $s$
%         is the super source of the flow problem. Consequently, all nodes connected to $s$
%         are source nodes in the corresponding \emph{multi-source multi-sink} flow problem.}
%\label{img:delta_proof_illustration}
%\end{figure}


%\begin{figure}
%\centering
%\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/cut_border_hyperedges.eps}
%\caption{Illustration of modeling \emph{Cut Border Hyperedges} as sources and sinks. In this
%         example $e_1$ contains node from block $V_1$ and $V_2$ not contained in the flow problem. Therefore,
%         we can not remove $e_1$ from cut. Treating $e_1$ as a \emph{Border Hyperedge} would result
%         in Transformation $1$. This has the consequence that we are not able to remove $e_2$
%         from cut with a \emph{Max-Flow-Min-Cut} computation. Defining the \emph{incoming} resp.
%         \emph{outgoing} hyperedge of $e_1$ as source resp. sinks allows the corresponding hypernodes
%         of $e_1$ still to move. The consequence is that we can remove $e_2$ from cut with a
%         \emph{Max-Flow-Min-Cut} computation in Transformation $2$. }
%\label{img:cut_border_hyperedges}
%\end{figure}
