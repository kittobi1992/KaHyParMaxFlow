We will now give a detailed overview of our flow-based refinement framework. The main
idea is to extract a subhypergraph $H_{V'}$ out of a hypergraph $H$, which is already
partitioned into $k$ blocks. $V'$ is chosen in such way that it is a subset of two
adjacent blocks $V_i$ and $V_j$. We will show how to configure
the sources $S$ and sinks $T$ of the corresponding flow network such that
a minimum $(S,T)$-bipartition of $H_{V'}$ improves the connectivity metric of $H$
(see Section \ref{sec:source_and_sink}). Further, we describe how the ideas of
Sanders and Schulz \cite{sanders2011engineering} 
can be adapted to work in an $n$-level hypergraph partitioner, called \emph{KaHyPar}. 

\subsection{Source and Sink Configuration}
\label{sec:source_and_sink}

Let $H = (V,E,c,\omega)$ be a hypergraph and $B_1$ be a bipartition of $H$.
In the following, we show how to configure the source set $S$ and sink set $T$ of the flow
network $T_L(H_{V'})$ of a subhypergraph $H_{V'}$ induced by $V' \subseteq V$. The goal is 
to improve bipartition $B_1$ of $H$ with a maximum $(S,T)$-flow calculation 
on $T_L(H_{V'})$ (with $f$ as maximum flow) such that after inserting the minimum 
$(S,T)$-bipartition of $H_{V'}$ on $H$ the resulting bipartition $B_2$ of $H$ has a 
cut less than or equal to the cut of $B_1$.
Let $E_{\text{cut}}(V',B) := \{ e \in E\ |\ \lambda(e,B) > 1 \land e \cap V' \neq \emptyset\}$ 
be the set of all cut hyperedges of bipartition $B$ of $H$ which are partially or fully contained in $H_{V'}$.
We define the cut of subhypergraph $H_{V'}$ related to a bipartition $B$ of $H$
as follows:
\[\omega_{H_{V'}}(B) := \sum_{e \in E_{\text{cut}}(V',B)} \omega(e) \]
Note, the cut $\omega_{H_{V'}}$ is defined over the
cut nets of $H$. A cut hyperedge $e$ of $H$ is not necessarily a cut hyperedge
of $H_{V'}$. If $e = \{v_1,v_2\}$ is a hyperedge with $v_1 \in V_1$ and $v_2 \in V_2$ and
$v_1 \in V'$ and $v_2 \notin V'$, then $e$ is cut in $H$, but not in $H_{V'}$, because
$v_2$ is removed from $e$ of $H_{V'}$ per definition. However, the reason that we still
define $e$ as cut hyperedge of $H_{V'}$ has to do with our problem statement, 
which we will define as follows:

\begin{problem}
\label{prob:ST} 
How do we have to define the source set $S$ and sink set $T$ for a subhypergraph $H_{V'}$ 
(with $V' \subseteq V$) and a bipartition $B_1$ such that 
after a maximum $(S,T)$-flow calculation (with $f$ as maximum flow)
the resulting minimum $(S,T)$-bipartition $B_2$ of $H$ satisfy the following conditions:
\begin{enumerate}
\item $\omega_H(B_2) \le \omega_H(B_1)$
\item $\Delta_{H} := \omega_H(B_1) - \omega_H(B_2) = \omega_{H_{V'}}(B_1) - |f| =: \Delta_{H_{V'}}$
\end{enumerate}
\end{problem}

The first condition ensures that a maximum $(S,T)$-flow calculation on $T_L(H_{V'})$ never 
decrease the cut of $H$. The existence of the second condition has practical reasons. First, we
can simply update the cut metric via $\omega_H(B_2) = w_H(B_1) - \Delta_{H_{V'}}$,
instead of summing up the weight of all cut hyperedges. Since we have to setup the subhypergraph
$H_{V'}$ before each maximum flow computation, we can implicitly calculate $\omega_{H_{V'}}(B_1)$.
Therefore, the cut metric can be updated after a \emph{Max-Flow-Min-Cut} computation
in constant time instead of \BigO{|E|}. On the other hand, we can assert the correctness of
our maximum flow algorithm. If $\Delta_H \neq \Delta_{H_{V'}}$, then with high probability our
flow algorithm is incorrect. The reason why we define $\omega_{H_{V'}}(B)$ over
the cut hyperedges of $H$ is that the equality
\[\Delta_{H} := \omega_H(B_1) - \omega_H(B_2) = \omega_{H_{V'}}(B_1) - \omega_{H_{V'}}(B_2)\]
holds only if we use the adapted defintion. 
Further, if we can show that $|f| = \omega_{H_{V'}}(B_2)$, we simultaneously show
that our source and sink set modeling approach satisfies condition (ii) 
$\Delta_H = \Delta_{H_{V'}}$.\\
We will now present a solution for our problem statement. First, we show how $S$ and $T$
can be chosen to satisfy condition (i). Afterwards, we extend $S$ and $T$ with additional
nodes to fulfil condition (ii). \\
Let $V' \subseteq V$ and $\delta B = \{ e \in E\ |\ \exists u,v \in e: u \in V'\ \land\ v \notin V' \}$
be the set of all \emph{border hyperedges} (see \autoref{img:balanced_bipartition}). 
Further, we divide $\delta B$ into two disjoint subsets:
\begin{enumerate}
\item Non-Cut hyperedges $e \in \delta B$ of $H$: $\delta B_1 = \{ e \in \delta B \ |\ e \subseteq V_1\ \lor\ e \subseteq V_2 \}$
\item Cut hyperedges $e \in \delta B$ of $H$: $\delta B_2 = \delta B \setminus \delta B_1$
\end{enumerate}
For a bipartition $(V_1,V_2)$ of $H$, we say
$v \in V_1$ is a source node of the flow network $T_L(H_{V'})$, if there exists
a hyperedge $e \in \delta B_1$ containing $v$. More formal:
\begin{align}
%S = \bigcup\limits_{\substack{e \in \delta B \\ |e \setminus V' \cap V_1| \neq 0}} (e \cap V_1 \cap V') \\
S_1 = \{ s \in V' \cap V_1\ |\ \exists e \in \delta B_1: s \in e \} \label{S1_border_hyperedges}\\
T_1 = \{ t \in V' \cap V_2\ |\ \exists e \in \delta B_1: t \in e \} \label{T1_border_hyperedges}
\end{align}
An example of a \emph{Max-Flow-Min-Cut} computation of $H_{V'}$ with $S$ and $T$ as source and
sink set is illustrated in \autoref{img:border_hyperedges}.
\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/border_hyperedges.eps}
\caption{Non-cut \emph{border hyperedges} of $H$ and $H_{V'}$ induce source and sink hypernodes
         in the flow problem.}
\label{img:border_hyperedges}
\end{figure}

\begin{lemma}
\label{cut_decrease_proof}
Let $B_1$ be a bipartition of $H$ and $T_L(H_{V'})$ the flow network of subhypergraph
$H_{V'}$ with $S$ and $T$ as defined in Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges} (with $V' \subseteq V$).
If $B_2$ is a bipartition obtained by a maximum $(S,T)$-flow computation on $T_L(H_{V'})$,
then the inequality $\omega_H(B_2) \le \omega_H(B_1)$ holds.
\end{lemma}

\begin{proof}
A maximum $(S,T)$-flow computation on $T_L(H_{V'})$ yields a minimum $(S,T)$-cutset on 
$H_{V'}$ \cite{ford1956maximal}. Thus, for all hyperedges $e \notin \delta B$ (fully contained in $H_{V'}$)
which are cut in $B_2$, the sum of their weight must be less or equal than the sum of all cut hyperedges
$e \notin \delta B$ of bipartition $B_1$. We have to show that a non-cut
hyperedge $e \in \delta B_1$ of $B_1 = (V_1,V_2)$ cannot become a cut hyperedge of
$B_2 = (V_1',V_2')$. Let $e \in \delta B_1$ be such a hyperedge. $e$ must be either a subset of $V_1$ or $V_2$, otherwise
$e$ is a cut hyperedge. Let $e \subseteq V_1$, then $e \cap V' \subseteq S$ (see Equation \ref{S1_border_hyperedges}). 
Defining a node $s \in S$ as source node means that it cannot change its block after a \emph{Max-Flow-Min-Cut}
computation. Therefore, $e \subseteq V_1$ and $e \subseteq V_1' \Rightarrow e$ is a non-cut
hyperedge of $B_2$. The proof for $e \subseteq V_2$ is equivalent $\Rightarrow \omega_H(B_2) 
\le \omega_H(B_1)$.
\end{proof} 
\begin{figure}[ht!]
\centering
\includegraphics[width=1.0\textwidth]{../img/source_and_sink_set/non_cut_flow_hyperedges.eps}
\caption{In this example $e_1$ and $e_3$ are cut hyperedges of the hypergraph, but non-cut nets
        of subhypergraph $H_{V'}$. Modeling the \emph{outgoing} resp.
        \emph{incoming} hyperedge node of $e_1$ resp. $e_2$ as sink resp. source ensures
        that $\Delta_H = \Delta_{H_{V'}}$.} 
\label{img:non_cut_flow_hyperedges}
\end{figure}

In the next step, we will show how $S$ and $T$ can be extended to satisfy condition (ii)
of Problem \autoref{prob:ST}. Currently, $|f| \le \omega_{H_{V'}}(B_2)$ (without a prove).
Obviously, some nodes are missing in $S$ and $T$. Consider \autoref{img:non_cut_flow_hyperedges}
to understand which nodes are missing. Transformation $1$ illustrates our current modeling
approach defined in Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges}. The maximum
flow on this network is $|f| = 1$, but the resulting minimum $(S,T)$-bipartition $B_2$ induce
a cut of $\omega_{H}(B_2) = 2$. This implies that $\Delta_H = 3 - 2 \neq 3 - 1 = \Delta_{H_{V'}}$.
The hyperedges $e_1$ and $e_3$ are cut nets of $H$, but non-cut hyperedges of $H_{V'}$. 
Therefore, $B_1$ induce a cut of $1$ on $H_{V'}$ if we define the cut $\omega_{H_{V'}}(B_2)$
over the cut hyperedges of $H_{V'}$ instead of the cut hyperedges of $H$. In our example, we can
remove $e_2$ from cut, but $e_1$ becomes a cut hyperedge of $H_{V'}$. Therefore, the value of the
cut of $H_{V'}$ does not change, but the cut of $H$ does. $e_1$ is already a cut hyperedge of $H$ and $B_2$ removes
$e_2$ from the cut of $H$. Therefore, $\Delta_H = 1$. However, we defined $\omega_{H_{V'}}(B_2)$
over the cut hyperedges of $H$ and currently, we hvae $|f| = 1 \neq 2 = \omega_{H_{V'}}(B_2)$. \\
Transformation $2$ illustrates the adapted modeling approach for cut hyperedges of $H$.
For each hyperedge $e \in \delta B_2$ with $e \setminus V' \cap V_1 \neq \emptyset$, 
we add the \emph{incoming hyperedge node} $\incoming{e}$ to $S$.
More formal:
\begin{align}
S = S_1 \cup \{\incoming{e} \in \delta B_2\ |\ e \setminus V' \cap V_1  \neq \emptyset\} \label{S_border_hyperedges}\\
T = T_1 \cup \{\outgoing{e} \in \delta B_2\ |\ e \setminus V' \cap V_2 \neq \emptyset \} \label{T_border_hyperedges}
\end{align}

\begin{definition}[Extension of a Subhypergraph]
\label{def:sub_extension}
We define the extension $\SubExtension$ of a subhypergraph $H_{V'}$ such that each hyperedge of $H = (V,E,c,\omega)$ which is
partially contained in $H_{V'}$ is fully contained in $\SubExtension$. More formally,
$\SubExtension = (V' \cup V'', E', c, \omega)$ with $V'' = \bigcup_{e \in \delta B} e \setminus V'$
and $E' = \{e \in E\ |\ e \subseteq (V' \cup V'')\}$.
\end{definition}

We have to show that for a maximum $(S,T)$-flow $f$ of $T_L(H_{V'})$ holds $|f| = \omega_{H_{V'}}(B_2)$.
The idea of the proof is to use the extension $\SubExtension$ of $H_{V'}$ and add 
all $V'' \cap V_1$ to $S_1$ (see Equation \ref{S1_border_hyperedges}) and all $V'' \cap V_2$ to
$T_1$ (see Equation \ref{T1_border_hyperedges}). We can show that for a maximum $(S_1,T_1)$-flow 
$f'$ of $T_L(\SubExtension)$ holds that $|f'| = \omega_{H_{V'}}(B_2)$.\\
Afterwards, we use a technique to remove all $v \in V''$ of $T_L(\SubExtension)$ and show
that the resulting flow network is $T_L(H_{V'})$ with $S$ and $T$ as source and sink set as
defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges}. Moreover, for a maximum
$(S,T)$-flow $f$ then holds that $|f| = |f'| = \omega_{H_{V'}}(B_2)$. \\
Because of the complexity of the proof, we will introduce lemmas in the following which
will simplify the proof of the main theorem. Consider \autoref{img:general_source_and_sink}~if you
need an illustration for the following lemmas.

\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/general_source_and_sink.eps}
\caption{Illustration of the proof technique used in Lemma \ref{lemma:general_source_and_sink_removal}.
         The green node $s$ is the super source of the flow problem. The blue nodes are source nodes of
         the corresponding \emph{multi-source multi-sink} flow problem. The red nodes $u$ and $v$ are
         contained in $\mathcal{R}(s_2)$. Therefore, edges $(s_2,u)$ and $(s_2,v)$ are removable.}
\label{img:general_source_and_sink}
\end{figure}

\begin{lemma}[Source Edge Removal]
\label{lemma:source_edge_removal}
Let $f$ be a maximum $(S,T)$-flow of $G = (V,E,\capa)$. If there exists two edges $(s_1,v)$ and $(s_2,v)$
with infinite capacity ($s_1,s_2 \in S$) we can either remove $(s_1,v)$ or $(s_2,v)$ from $G$
without changing the amount of a maximum $(S,T)$-flow.
\end{lemma}

\begin{proof}
Let $P = (s_1,v,\ldots)$ be an augmenting path of $G$. Replacing $s_1$ in $P$ with $s_2$ yields
an augmenting path $P'$ of same length. The operation is valid because $\capacity{s_1,v} = \capacity{s_2,v} = \infty$. 
If we execute Edmond and Karp's maximum flow algorithm we can map each augmenting path 
$P$ to $P'$ and ensure that for a maximum $(S,T)$-flow $f$ follows that $f(s_1,v) = 0$. 
Consequently, there exists maximum $(S,T)$-flows where either $f(s_1,v) = 0$ or $f(s_2,v) = 0$.
Therefore, we can remove either $(s_1,v)$ or $(s_2,v)$ without changing the amount of
a maximum $(S,T)$-flow.
\end{proof}

\begin{lemma}[Sink Edge Removal]
\label{lemma:sink_edge_removal}
Let $f$ be a maximum $(S,T)$-flow of $G$. If there exists two edges $(v,t_1)$ and $(v,t_2)$
with infinite capacity ($t_1,t_2 \in T$) we can either remove $(v,t_1)$ or $(v,t_2)$ from $G$
without changing the amount of a maximum $(S,T)$-flow.
\end{lemma}

\begin{proof}
Equivalent to proof of Lemma \ref{lemma:source_edge_removal}.
\end{proof}

\begin{definition}[Removable Edges]
We denote the set of all adjacent nodes $v$ of a source node $s$ resp. sink node $t$, where
edge $(s,v)$ or $(v,t)$ is removable according to Lemma \ref{lemma:source_edge_removal}
and \ref{lemma:sink_edge_removal}, with $\mathcal{R}(s)$ resp. $\mathcal{R}(t)$.
\end{definition}

The following lemma is a generalisation of Lemma \ref{lemma:source_and_sink_removal}. We will use
the definition of $in(u)$ and $out(u)$ presented in Section \ref{sec:heuer_network}. Further,
$G_{V'}$ is a subgraph of $G = (V,E)$ induce by $V' \subseteq V$ (see Defintion \ref{def:subgraph}).

\begin{lemma}[General Source/Sink Node Removal]
\label{lemma:general_source_and_sink_removal}
Let $f$ be a maximum $(S,T)$-flow of $G = (V,E,\capa)$ with $|f| < \infty$ and
$E_s \subseteq \mathcal{R}(s)$ and $E_t \subseteq \mathcal{R}(t)$ with $s \in S$
and $t \in T$.
If $s$ is a source node where all outgoing edges have infinte capacity and
$t$ is a sink node where all incoming edges have infinte capacity, then
$|f|$ is equal with the amount of a maximum $(S',T)$-flow of $G_{V\setminus \{s\}}$ and a maximum
$(S,T')$-flow of $G_{V\setminus \{t\}}$, where $S' = (S\setminus \{s\}) \cup (out(s) \setminus E_s)$ 
and $T' = (T \setminus \{t\}) \cup (in(t) \setminus E_t)$.
\end{lemma}

\begin{proof}
$E_s$ is an arbitrary subset of $\mathcal{R}(s)$, where foreach $v \in E_s$ the edge $(s,v)$ is removable.
$S'$ is the source set without node $s$ extended with all outgoing edges of 
$s$ minus the removable edges $E_s$. With Lemma \ref{lemma:source_edge_removal}
we can remove all edges $(s,v)$ with $v \in E_s$ from $G$ and obtain flow network $G'$. Finally, we can
apply Lemma \ref{lemma:source_and_sink_removal} on $G'$ and obtain $G_{V\setminus \{s\}}$ with $(S',T)$ as source
and sink set (see \autoref{img:general_source_and_sink}). All used Lemma's did not change the amount of a maximum flow. Therefore, a maximum
$(S,T)$-flow of $G$ is equal with a maximum $(S',T)$-flow of $G_{V\setminus \{s\}}$. The proof for $t$ is
equivalent.
\end{proof}

The proof of Lemma \ref{cut_decrease_proof} can be applied one-to-one on our new source and
sink sets because $S_1 \subseteq S$ and $T_1 \subseteq T$. Therefore, $S$ and $T$ 
as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges} satisfies
condition (i) of Problem \ref{prob:ST}. We will show that for $S$ and $T$ 
the equality $\Delta_H = \Delta_{H_{V'}}$ holds.

\begin{theorem} 
\label{lemma:delta_proof}
Let $B_1 = (V_1,V_2)$ be a bipartition of $H$ and $T_L(H_{V'})$ the flow network of subhypergraph
$H_{V'}$ with $S$ and $T$ as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges} (with $V' \subseteq V$).
If $B_2$ is a bipartition obtained by a maximum $(S,T)$-flow computation on $T_L(H_{V'})$
with $f$ as maximum flow,
then $\omega_{H_{V'}}(B_2) = |f|$ ($\Rightarrow \Delta_H = \Delta_{H_{V'}}$).
\end{theorem}

\begin{proof}
Consider the extension $\SubExtension$ of subhypergraph $H_{V'}$ (see Definition \ref{def:sub_extension}).
Each maximum $(S,T)$-flow $f'$ of $T_L(\SubExtension)$ is then equal with a minimum-weight
$(S,T)$-cutset of $H_{V'}$ according to our definition of the cut $\omega_{H_{V'}}(B_2)$ over
the cut hyperedges of $H$. Because each hyperedge which is partially contained in $H_{V'}$
is fully contained in $\SubExtension$. Therefore, it holds that $|f'| = \omega_{H_{V'}}(B_2)$.
However, we have to model some restrictions into our source and sink set of $T_L(\SubExtension)$.
We will denote the source and sink set of $T_L(\SubExtension)$ with $S'$ and $T'$.
Each hypernode contained in a non-cut border hyperedge $e \in \delta B_1$ should not be able to move
such that we ensure that $e$ is not cut after a maximum $(S',T')$-flow calculation. Therefore,
we add $S_1$ and $T_1$ to $S'$ and $T'$ (see Equation \ref{S1_border_hyperedges} and \ref{T1_border_hyperedges}).
Further, all hypernodes $v \in V''$ (see Defintion \ref{def:sub_extension}) are not contained in
$H_{V'}$. Consequently, they cannot change their block if we calculate a maximum $(S,T)$-flow of
$T_L(H_{V'})$. Therefore, we add $V'' \cap V_1$ to $S'$ and $V'' \cap V_2$ to $T'$.
With $S'$ and $T'$ as source and sink set we ensure that only hypernodes $v \in V'$ are able
to move and since $S_1 \subseteq S'$ and $T_1 \subseteq T'$, we ensure that $\omega_H(B_2) \le \omega_H(B_1)$
(see Lemma \ref{cut_decrease_proof}). \\
In the following, we apply Lemma \ref{lemma:general_source_and_sink_removal} on all
hypernodes $v \in V''$ such that the flow network $T_L(\SubExtension)$ converge against
$T_L(H_{V'})$ with $S$ and $T$ as source and sink set as defined in Equation 
\ref{S_border_hyperedges} and \ref{T_border_hyperedges} \emph{without} changing the
amount of the maximum flow $f'$. Since $|f'| = \omega_{H_{V'}}(B_2)$, for a maximum $(S,T)$-flow
$f$ of $T_L(H_{V'})$ then holds $|f| = \omega_{H_{V'}}(B_2)$. Per definition a node $v \in V''$
is either a source or sink node. For each source node $s \in V''$ we have to 
define a removable subset $E_s \subseteq \mathcal{R}(s)$ such that after removing all $s \in S' \cap V''$
the resulting source set $S$ is equal to Equation \ref{S_border_hyperedges}. The technique
for removing each sink node $t \in S' \cap V''$ will be equivalent. For a source node $s \in V''$
we define $E_s = \{\incoming{e}\ |\ e \in I(s) \cap \delta B_1\}$. Remember, $\delta B_1$ contains
all non-cut border hyperedges of $H$. Thus, for each $e \in I(s) \cap \delta B_1$ exists
a source node $\bar{s} \in V'$ of $S_1$ such that edges $(s,\incoming{e})$ and $(\bar{s},\incoming{e})$
are contained in $T_L(\SubExtension)$ (see \autoref{img:delta_proof_illustration}). Therefore, $E_s$ is a removable subset of $\mathcal{R}(s)$.
For each $t \in T' \cap V''$ we define the removable subset $E_t = \{\outgoing{e}\ |\ e \in I(t) \cap \delta B_1\}$.
Applying Lemma \ref{lemma:general_source_and_sink_removal} on all source nodes $s \in V''$
with $E_s$ as removable subset and on all sink nodes $t \in V''$ with $E_t$ 
as removable subset yield flow network $T_L(H_{V'})$ with $S$ and $T$ as source and sink 
set as defined in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges}.
A hyperedge $e \in \delta B_1$ cannot become a source or sink node because if we remove a 
source node $s \in e$ then $e'$ is in the removable subset $E_s$ (see \autoref{img:delta_proof_illustration}). The same holds
for each sink node $t \in V''$. A hyperedge $e \in \delta B_2$ becomes a source node of $S$
if we remove a source node $s \in e$ and a sink node of $T$ if we remove a 
sink node $t \in e$ because $\forall e \in \delta B_2: e',e'' \notin E_s \cup E_t$. 
Therefore, $S$ and $T$ are equal to our source and sink set defintion and
for a maximum $(S,T)$-flow $f$ it holds that $|f| = |f'| = \omega_{H_{V'}}(B_2)$.
\end{proof}

\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/delta_proof_illustration.eps}
\caption{Illustration how to remove a source node $v \in V''$. Note, the green node $s$
         is the super source of the flow problem. Consequently, all nodes connected to $s$
         are source nodes in the corresponding \emph{multi-source multi-sink} flow problem.}
\label{img:delta_proof_illustration}
\end{figure}


%\begin{figure}
%\centering
%\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/cut_border_hyperedges.eps}
%\caption{Illustration of modeling \emph{Cut Border Hyperedges} as sources and sinks. In this
%         example $e_1$ contains node from block $V_1$ and $V_2$ not contained in the flow problem. Therefore,
%         we can not remove $e_1$ from cut. Treating $e_1$ as a \emph{Border Hyperedge} would result
%         in Transformation $1$. This has the consequence that we are not able to remove $e_2$
%         from cut with a \emph{Max-Flow-Min-Cut} computation. Defining the \emph{incoming} resp.
%         \emph{outgoing} hyperedge of $e_1$ as source resp. sinks allows the corresponding hypernodes
%         of $e_1$ still to move. The consequence is that we can remove $e_2$ from cut with a
%         \emph{Max-Flow-Min-Cut} computation in Transformation $2$. }
%\label{img:cut_border_hyperedges}
%\end{figure}

We are now able to extract a subhypergraph $H_{V'}$ out of an already bipartitioned hypergraph $H$ and
calculate a minimum $(S,T)$-bipartition of $H_{V'}$ with $S$ and $T$ as defined
in Equation \ref{S_border_hyperedges} and \ref{T_border_hyperedges}. The resulting
bipartition induce a new cut on $H$ smaller or equal than the old cut. Further, we show with our
modeling technique of $S$ and $T$ that $\Delta_H$ can be calculated with the help of the amount 
of a maximum $(S,T)$-flow computation on $T_L(H_{V'})$. \\
\begin{figure}[ht!]
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/st_modelling_summary.eps}
\caption{Illustration of modeling sources and sinks defined in Equation \ref{S_border_hyperedges}
         and \ref{T_border_hyperedges}. }
\label{img:st_modelling_summary}
\end{figure}
In Section \ref{sec:edge_size_network} we described how to remove hyperedges of size $|e| = 2$ 
by adding an undirected flow edge between the corresponding vertices $u,v \in e$. However, if
the incoming or outgoing hyperedge node is a source or a sink node, we can not directly
remove the hyperedge nodes. There are two special cases which are illustrated
in \autoref{img:edge_size_two}. This situation occurs if one of the two vertices is part
of the flow problem and one not. In case, if the incoming hyperedge node $\incoming{e}$ is a source node, 
we only remove the outgoing hyperedge node $\outgoing{e}$ and add a directed flow edge from $\incoming{e}$ 
to $v$ with capacity $\omega(e)$. In the second case, if the outgoing hyperedge node $\outgoing{e}$ is
a sink node, we only remove the incoming hyperedge node $\incoming{e}$ and add a directed flow edge from
$v$ to $\outgoing{e}$ with capacity $\omega(e)$.\\
\begin{figure}
\centering
\includegraphics[width=0.95\textwidth]{../img/source_and_sink_set/edge_size_two.eps}
\caption{Illustration of modeling hyperedges of size two if the incoming or outgoing
         hyperedge node is a source or a sink node of the flow problem.}
\label{img:edge_size_two}
\end{figure}
With the given approach we can optimize the cut metric of a given
bipartition of a hypergraph $H$. We can transfer those results to improve
a $k$-way partition $\Pi = (V_1,\ldots,V_k)$ if the objective is the connectivity
metric. Let $V' \subseteq V_i \cup V_j$ be a subset of the hypernodes of two adjacent
blocks $V_i$ and $V_j$. If we optimize the cut of
subhypergraph $H_{V'}$ we simultaneously optimize the connectivity metric of $H$.
The reduction of the cut of $H_{V'}$ is then equal with the decrease in
the connectivity metric of $H$.

\subsection{Most Balanced Minimum Cuts on Hypergraphs}
\label{sec:mbmc_hypergraphs}

Picard and Queyranne \cite{picard1980structure} show that all minimum $(s,t)$-cuts 
of a graph $G$ are computable with one maximum $(s,t)$-flow computation by 
iterating through all \emph{closed node sets} of the residual graph of $G$. 
The corresponding algorithm is presented in Section \ref{sec:related_mbmc}. \\
We can apply the same algorithm on hypergraphs. A minimum-capacity $(s,t)$-cutset of \ShortT{L}
is equal with a minimum-weight $(s,t)$-cutset of $H$. With the algorithm
of Section \ref{sec:related_mbmc} we can find all minimum-capacities
$(s,t)$-cutsets of \ShortT{L}, which are also minimum-weight $(s,t)$-cutsets
of $H$. The corresponding minimum-weight $(s,t)$-bipartitions are all
\emph{closed node sets} of the residual graph of \ShortT{L}. \\
However, when we use e.g. \ShortExT{H}{V'} (see Section \ref{sec:heuer_network})
or \ShortHybrid~(see Section \ref{sec:hybrid_network}) as underlying flow network,
some hypernodes are removed from the flow problem. It is a problem if we want to
enumerate all minimum-weight $(s,t)$-bipartitions. The solution for 
this problem is quite simple. After a maximum $(s,t)$-flow calculation
on one of the two mentioned networks we insert all removed hypernodes with
their corresponding edges again into the residual graph of our flow network.
The maximum $(s,t)$-flow is still maximal. Otherwise, we would have found an \emph{augmenting
path} on the flow network before. We are now able to compute all minimum-weight
$(s,t)$-bipartitions the same way as with \ShortT{L}.

\subsection{A direct $k$-way Flow-Based Refinement Framework}
\label{sec:flow_local_search_hypergraph}

We have described how a hypergraph $H$ could be transformed into
a flow network \ShortT{L} such that each minimum-capacity $(S,T)$-cutset of \ShortT{L} is a 
minimum-weight  $(S,T)$-cutset of $H$ (see Section \ref{sec:related_lawler}). 
Additionaly, we present techniques to sparsify the
flow network \ShortT{L} \cite{lawler1973} to reduce the complexity of 
the flow problem (see Section \ref{sec:opt_flow_network}). 
Further, we show how to configure the source and sink sets of a flow network of a 
subhypergraph $H_{V'}$ (with $V' \subseteq V$) such that a \emph{Max-Flow-Min-Cut} 
computation improves a given bipartition of $H$ (see Section \ref{sec:source_and_sink}). 
Finally, we can enumerate all minimum-weight $(s,t)$-cutsets of a subhypergraph 
$H_{V'}$ with one maximum $(S,T)$-flow calculation \cite{picard1980structure}. \\
We will now present our direct $k$-way flow-based refinement framework which we integrated
into the $n$-level hypergraph partitioner \emph{KaHyPar} \cite{heuer2017improving} 
(see Section \ref{sec:kahypar}). Our flow-based refinement approach optimizes
the \emph{connectivity} metric. We used a similiar architecture as proposed
by Sanders and Schulz \cite{sanders2011engineering} (see Section 
\ref{sec:flow_local_search_graph}). The basic concepts of the framework are
illustrated in \autoref{img:flow_framework}. \\
Our maximum flow calculations are embedded into an \emph{Active Block Scheduling}
refinement \cite{holtgrewe2010engineering} (see Section \ref{sec:abs}).
Each time we use flows to improve the connectivity metric of
a given $k$-way partition $\Pi$ we construct the quotient graph $Q$ of $\Pi$. 
Afterwards, we iterate over all edges of $Q$ in random order. For each edge
$(V_i,V_j)$ of $Q$, we build a flow problem around the cut of the bipartition
induced by $V_i$ and $V_j$. To do that we use two \BFS, one only 
touches hypernodes of $V_i$ and the second only touches hypernodes of $V_j$.
The \BFS~is initialized with all hypernodes contained in a cut hyperedge
of the bipartition $(V_i,V_j)$. A pairwise flow-based refinement is embedded
into the \emph{adaptive flow iterations} strategy \cite{sanders2011engineering}
(see Section \ref{sec:adaptive_flow_iterations}) which also determines
the size of the flow problem. \\
After we define the subhypergraph $H_{V'}$, which we use to improve the bipartition
$(V_i,V_j)$ on $H$, we construct one of the flow networks proposed in Section
\ref{sec:opt_flow_network} with sources $S$ and sinks $T$ defined in
Section \ref{sec:source_and_sink}. We implemented two maximum flow algorithms.
One is a slightly modified \emph{augmenting path} algorithm of Edmond \& Karp
\cite{edmonds1972theoretical} (see Section \ref{sec:aug_path}) 
and the second is the \emph{Push-Relabel} algorithm of
Goldberg \& Tarjan \cite{cherkassky1997implementing,goldberg1988new} 
(see Section \ref{sec:push_relabel}). Since we have a 
\emph{Multi-Source-Multi-Sink} problem, we can find several \emph{augmenting paths}
with one \BFS. After we execute a \BFS~on the residual graph, we search 
as many as possible edge-disjoint paths in the resulting \BFS-tree connecting a source $s$
with a sink $t$. Our Goldberg \& Tarjan implementation uses a \emph{FIFO} queue and
the \emph{global relabeling} and \emph{gap} heuristic \cite{cherkassky1997implementing}.
We do not use an external implementation of a maximum flow algorithm.
Since the \emph{I\textbackslash O} of writing a flow problem to memory and reading the
solution would significantly slowdown the performance of our algorithm because we have
to solve an enormous number of flow problems during the \emph{Active Block Scheduling}
refinement. After we determine a maximum $(S,T)$-flow on our flow network, we iterate over
all minimum $(S,T)$-bipartitions of $H_{V'}$ \cite{picard1980structure} and choose 
the \emph{Most Balanced Minimum Cut} (see Section \ref{sec:related_mbmc} and 
\ref{sec:mbmc_hypergraphs}) according to our \emph{balanced constraint}. \\
\emph{KaHyPar} is an $n$-level hypergraph partitioner ($|V| = n$) taking the 
multilevel paradigm to its extreme by removing only a single vertex in every level
of the hierarchy \cite{akhremtsev2017engineering} (see Section \ref{sec:kahypar}). 
During the refinement step $n$ local searches are instantiated. Therefore, 
using our flow-based refinement as local search algorithm on each level is not 
applicable, because the performance slowdown would be tremendous. Therefore,
we introduce \emph{Flow Execution Policies}. One is to execute our flow-based
refinement on each level $i$ where $i = \beta\cdot j$ with $j \in \mathbb{N}_+$ and
$\beta$ as a predefined tunning parameter. Another approach is to simulate a
multilevel partitioner with $\log(n)$ hierarchies. A flow-based refinement is then
executed on each level $i$ where $i = 2^j$ with $j \in \mathbb{N}_+$. Each policy also
performs the \emph{Active Block Scheduling} refinement on the last level of the
hierarchy. In all remaining levels where no flow is executed, we can use an 
\emph{FM}-based local search algorithm 
\cite{akhremtsev2017engineering,fiduccia1988linear,sanchis1989multiple} (see Section 
\ref{sec:abs}). \\
An observation during the implementation of this framework was that only a minority
of the pairwise refinements based on flows yields to an improvement of the connectivity
metric on hypergraph $H$. Thus, we introduce several rules which might prevent
unnecessary flow executions to improve the effectiveness ratio by simultaneously speeding up
the running time.

\begin{enumerate}
\item[(R1)] If a flow-based refinement did not lead to an improvement on two blocks in all previous
            executions, we would use flows only in the first iteration of 
            \emph{Active Block Scheduling}.
\item[(R2)] If the cut between two adjacent blocks in the quotient graph is small (e.g. $\le 10$) we
            skip the flow-based refinement on these blocks except on the last level of the hierarchy.
\item[(R3)] If the value of the cut of a minimum $(S,T)$-bipartition of $H_{V'}$ is the same 
            as the cut before, we stop the pairwise refinement.
\end{enumerate}

\begin{figure}
\centering 
\includegraphics[width=1.0\textwidth]{../img/flow_local_search/flow_framework_hypergraph.eps}
\caption{Illustration of our flow-based refinement framework for direct $k$-way hypergraph
         partitioning.}
\label{img:flow_framework}
\end{figure} 